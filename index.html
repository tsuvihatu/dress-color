<!DOCTYPE html>
<html lang="ja">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7B3GLZNM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GK7B3GLZNM');
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>„Éâ„É¨„Çπ„ÅÆËâ≤„ÅÇ„Å¶„ÇØ„Ç§„Ç∫</title>

<meta property="og:title" content="„Éâ„É¨„Çπ„ÅÆËâ≤„ÅÇ„Å¶„ÇØ„Ç§„Ç∫" />
<meta property="og:description" content="Êñ∞Â©¶„ÅÆ„ÅäËâ≤Áõ¥„Åó„ÅÆ„Éâ„É¨„Çπ„ÅØ‰ΩïËâ≤„Åß„Åó„Çá„ÅÜÔºü„Äå„Åì„Çå„Å†ÔºÅ„Äç„Å®ÊÄù„ÅÜËâ≤„ÇíÈÅ∏„Çì„ÅßÊäïÁ•®„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ" />
<meta property="og:type" content="website" />

<style>
  :root {
    --card-w: 380px;
    --accent: #ccd3ff;
    --accent-soft: rgba(230, 163, 175, 0.35);

    --gold-main: #cda156;
    --text-main: #5a3b40;
    --text-sub: #7e5b60;
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  html {
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: grid;
    place-items: center;
    font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", serif;
    color: #5a3b40;
    background:
      linear-gradient(135deg, rgba(255,248,244,0.1), rgba(255,234,239,0.1)),
      #fdfcf8 url('file_back.jpg') center/cover no-repeat fixed;
    font-weight: 600;
    overscroll-behavior-y: none;
    padding: 24px 0;
    transition: all 0.5s ease;
  }

  body.large-mode {
    --text-main: #331a1e;
    --text-sub: #553338;
  }

  body.large-mode .card-sub { font-size: 15px; line-height: 1.8; font-weight: 700; color: #331a1e; }
  body.large-mode .field label { font-size: 15px; font-weight: 800; color: #4a252a; }
  body.large-mode .slider-label { font-size: 14px; font-weight: 800; color: #4a252a; }
  
  body.large-mode .btn-main { font-size: 16px; font-weight: 800; padding: 14px; }
  body.large-mode .btn-ghost { font-size: 13px; font-weight: 800; padding: 0 4px; letter-spacing: 0.05em; }
  
  body.large-mode input[type="text"] { font-size: 20px; font-weight: 700; border-bottom-width: 2px; color: #000; }
  body.large-mode .input-guide { font-size: 13px !important; font-weight: 700; color: #553338; }
  body.large-mode .note { font-size: 12px; font-weight: 700; color: #553338; }

  body.large-mode .modal h3 { font-size: 22px; font-weight: 800; }
  body.large-mode .modal-msg { font-size: 15px; font-weight: 700; line-height: 1.7; color: #331a1e; }
  body.large-mode .modal-guest-label { font-size: 11px; font-weight: 800; }
  body.large-mode .modal-guest-name { font-size: 24px; font-weight: 800; }
  body.large-mode .modal-btn { font-size: 15px; font-weight: 800; }
  
  body.large-mode .game-title { font-size: 18px; font-weight: 800; }
  body.large-mode #gameResultArea p { font-size: 14px !important; font-weight: 700; }
  
  body.large-mode .ranking-screen h3 { font-size: 24px; font-weight: 800; margin-bottom: 24px; }
  body.large-mode .my-score-fixed { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: #cda156; }
  body.large-mode .ranking-item { font-size: 18px; font-weight: 700; padding: 16px 14px; }
  body.large-mode .rank-badge { width: 32px; height: 32px; font-size: 16px; }
  body.large-mode .rank-name { font-size: 18px; }
  body.large-mode .rank-score { font-size: 20px; font-weight: 800; }
  body.large-mode #discoveryStatus {
    margin-top: 20px;
    font-size: 10px;
    text-align: center;
    color: rgba(122,78,84,0.5);
    letter-spacing: 0.05em;
    width: 100%;
    max-width: 340px;
    padding: 0 14px;
    box-sizing: border-box;
  }

  .discovery-wrap { width: 100%; }

  .discovery-remaining {
    font-size: 11px;
    margin-top: 2px;
  }

  .discovery-complete {
    font-size: 12px;
    font-weight: 800;
    color: var(--gold-main);
    letter-spacing: 0.06em;
  }

  .discovery-code-label { margin-top: 10px; font-weight: 700; }
  .discovery-code-note { margin-top: 8px; font-size: 10px; opacity: 0.9; }

  .discovery-cleared {
    margin-top: 14px;
    padding: 12px 12px;
    border-radius: 14px;
    background: rgba(255,255,255,0.65);
    border: 1px solid rgba(122,78,84,0.15);
    text-align: left;
  }

  .discovery-cleared-title {
    margin-bottom: 8px;
    font-weight: 700;
    text-align: center;
    opacity: 0.7;
    letter-spacing: 0.08em;
  }

  .discovery-cleared-item {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    line-height: 1.6;
  }
  .discovery-cleared-item .label {
    min-width: 0;
    overflow-wrap: anywhere;
    word-break: break-word;
  }
.unlock-code{
    display:inline-block;
    margin-top:10px;
    padding:8px 10px;
    border-radius:12px;
    border:1px dashed rgba(205,161,86,0.9);
    background: rgba(255,255,255,0.7);
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    letter-spacing: .12em;
  }

  .mode-return{
    margin-top: 14px;
    font-size: 12px;
    text-align: center;
    cursor: pointer;
    text-decoration: underline;
    color: rgba(122,78,84,0.65);
    user-select: none;
    -webkit-user-select: none;
  }
  .mode-return .mode-return-text{ text-decoration: underline; }

  body.alt-8bit .mode-return{ display:flex !important; align-items:center; justify-content:center; gap:10px; text-decoration:none; }
  body.alt-8bit .slider-group{
    background: rgba(255,255,255,0.06);
    border-radius: 0;
    border: 2px solid rgba(234,255,246,.22);
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.6);
  }
  body.alt-8bit .color-chip{ border-radius: 0; border: 2px solid var(--gold-main); box-shadow: inset 0 0 0 2px rgba(0,0,0,.6); }
  body.alt-8bit .btn-ghost{ box-shadow: none; }
  body.alt-8bit .stock-dot{ border-radius: 0; border: 2px solid rgba(234,255,246,.35); box-shadow: inset 0 0 0 2px rgba(0,0,0,.6); }


  body.alt-8bit input[type="range"]{
    border-radius: 0;
    height: 14px;
    border: 2px solid rgba(234,255,246,.25);
    background:
      repeating-linear-gradient(90deg, rgba(234,255,246,.16) 0 2px, transparent 2px 6px),
      rgba(255,255,255,0.06);
  }
  body.alt-8bit input[type="range"]::-webkit-slider-runnable-track{ height: 14px; border-radius: 0; }
  body.alt-8bit input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance: none;
    width: 20px;
    height: 28px;
    border-radius: 0;
    background: var(--gold-main);
    border: 2px solid rgba(0,0,0,.75);
    box-shadow: 0 0 0 2px rgba(234,255,246,.25);
    transform: translateY(-9px);
  }
  body.alt-8bit input[type="range"]:active::-webkit-slider-thumb{
    transform: translateY(-9px) scale(1.05);
    box-shadow: 0 0 0 2px rgba(234,255,246,.5), 0 0 0 4px var(--pixel-glow);
  }
  body.alt-8bit input[type="range"]::-moz-range-track{ height: 14px; border-radius: 0; }
  body.alt-8bit input[type="range"]::-moz-range-thumb{
    width: 20px;
    height: 28px;
    border-radius: 0;
    background: var(--gold-main);
    border: 2px solid rgba(0,0,0,.75);
  }

  body.alt-8bit{
    --gold-main: #32ff9d;
    --pixel-glow: rgba(50,255,157,.16);
    --pixel-glow2: rgba(50,255,157,.10);
    --on-accent: #06120c;
    --bg-angle: 135deg;

    --text-main: #eafff6;
    --text-sub: rgba(234,255,246,.78);

    background:
      linear-gradient(var(--bg-angle), rgba(6,8,15,0) 0%, var(--pixel-glow2) 55%, rgba(6,8,15,0) 100%),
      radial-gradient(circle at 20% 20%, var(--pixel-glow), transparent 40%),
      radial-gradient(circle at 90% 80%, var(--pixel-glow2), transparent 55%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 2px, transparent 2px 6px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 2px, transparent 2px 6px),
      #06080f;
    color: var(--text-main);
    font-family: ui-monospace, Menlo, monospace;
  }

  body.alt-8bit .card{
    background: rgba(6,8,15,.92);
    border-radius: 0;
    border: 4px solid var(--gold-main);
    box-shadow: 0 0 0 4px var(--pixel-glow), 0 28px 60px rgba(0,0,0,.6);
    backdrop-filter: none;
  }
  body.alt-8bit .card::before,
  body.alt-8bit .card::after{ display:none; }

  body.alt-8bit .card-header::before{
    background: linear-gradient(90deg, transparent, var(--gold-main), transparent);
    opacity: .55;
  }

  body.alt-8bit h2{ color: var(--text-main); }
  body.alt-8bit .tagline{ color: rgba(234,255,246,.72); }
  body.alt-8bit .card-sub{ color: var(--text-sub); }
  body.alt-8bit .field label,
  body.alt-8bit .slider-label,
  body.alt-8bit .note{ color: var(--text-sub); }

  body.alt-8bit .stock-placeholder{ color: rgba(234,255,246,.55); }

  body.alt-8bit .btn-main{
    background: var(--gold-main);
    color: var(--on-accent);
    border-radius: 0;
    box-shadow: none;
  }
  body.alt-8bit .btn-ghost{
    border-radius: 0;
    background: rgba(255,255,255,.06);
    color: rgba(234,255,246,.9);
    border-color: rgba(234,255,246,.25);
  }

  body.alt-8bit input[type="text"]{
    border-bottom-color: rgba(234,255,246,.55);
    color:#fff;
  }
  body.alt-8bit input[type="text"]::placeholder{
    color: rgba(234,255,246,.55);
  }

  body.alt-8bit .a11y-toggle{
    color: rgba(234,255,246,.85);
  }
  body.alt-8bit .a11y-icon-wrapper{
    background: rgba(255,255,255,0.06);
    border-color: rgba(234,255,246,.35);
  }

  body.alt-8bit .mode-return{
    color: rgba(234,255,246,.85);
  }

  body.alt-8bit .modal-overlay{
    background: rgba(6,8,15,0.86);
    backdrop-filter: none;
  }
  body.alt-8bit .modal{
    background: rgba(6,8,15,0.96);
    border-radius: 0;
    color: rgba(234,255,246,0.95);
  }
  body.alt-8bit .modal::after{
    border-color: var(--gold-main);
    border-radius: 0;
  }
  body.alt-8bit .modal::before{
    color: rgba(234,255,246,0.8);
    opacity: 1;
  }
  body.alt-8bit .modal h3{
    color: rgba(234,255,246,0.98);
    border-bottom-color: rgba(234,255,246,0.25);
  }
  body.alt-8bit .modal-msg{
    color: rgba(234,255,246,0.85);
  }
  body.alt-8bit .modal-guest-label{
    color: rgba(234,255,246,0.75);
  }
  body.alt-8bit .modal-guest-name{
    color: rgba(234,255,246,0.98);
    border-bottom-color: rgba(234,255,246,0.35);
  }
  body.alt-8bit .btn-cancel{
    color: rgba(234,255,246,0.9);
    border-color: rgba(234,255,246,0.35);
    background: transparent;
  }
  body.alt-8bit .btn-cancel:active{
    background: rgba(234,255,246,0.08);
  }
  body.alt-8bit .btn-confirm{
    background: var(--gold-main);
    color: var(--on-accent);
    box-shadow: none;
  }
  body.alt-8bit .toast{
    bottom: auto;
    top: 18px;
    background: rgba(255,255,255,0.94);
    color: #06080f;
    border: 2px solid var(--gold-main);
    font-weight: 900;
    letter-spacing: .08em;
    box-shadow: 0 10px 30px rgba(0,0,0,.45);
  }

  .card {
    position: relative;
    width: min(var(--card-w), 94vw);
    background: rgba(255,255,255,0.75);
    border-radius: 24px;
    padding: 26px 22px 24px;
    border: 1px solid rgba(255,255,255,0.7);
    box-shadow:
      0 18px 40px rgba(204,150,153,0.35),
      0 0 0 1px rgba(255,255,255,0.8);
    backdrop-filter: blur(8px);
    z-index: 1;
    transform: translateZ(0); 
  }

  .card::before {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    background:
      radial-gradient(circle at 10% 0%, rgba(255,255,255,0.8), transparent 60%),
      radial-gradient(circle at 90% 110%, var(--accent-soft), transparent 70%);
    opacity: 0.6; 
    pointer-events: none;
    z-index: -1;
  }

  .card::after {
    content: "";
    position: absolute;
    inset: 10px;
    border-radius: 18px;
    border: 1px solid rgba(230,163,175, 0.65);
    box-shadow: inset 0 0 2px rgba(205, 161, 86, 0.15);
    pointer-events: none;
  }

  .a11y-toggle {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    padding: 8px;
    cursor: pointer;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.6; 
    transition: all 0.2s ease;
    color: var(--text-sub);
  }
  
  .a11y-toggle:hover { opacity: 1; transform: scale(1.05); }
  .a11y-toggle:active { transform: scale(0.95); }

  .a11y-icon-wrapper {
    width: 26px; 
    height: 26px;
    border: 1.5px solid currentColor; 
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: rgba(255,255,255,0.2); 
  }

  .a11y-char { 
    font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", serif; 
    font-size: 17px; 
    font-weight: 700; 
    line-height: 1;
    transform: translateY(1px);
  }

  body.large-mode .a11y-toggle {
    opacity: 1;
    color: var(--gold-main);
  }
  
  body.large-mode .a11y-icon-wrapper {
    background: var(--gold-main);
    border-color: var(--gold-main);
    color: #fff;
    box-shadow: 0 2px 8px rgba(205, 161, 86, 0.3);
  }

  .card-header { text-align: center; margin-bottom: 8px; }
  .card-header::before {
    content: ""; display: block; width: 80px; height: 1px; margin: 0 auto 6px;
    background: linear-gradient(90deg, transparent, rgba(230, 163, 175, 0.8), transparent);
  }

  .tagline { 
    margin: 0 0 4px; font-size: 10px; letter-spacing: 0.22em; text-transform: uppercase; color: rgba(140,90,100,0.7); 
    cursor: pointer; position: relative; display: inline-block;
  }
  .tagline.pressing { color: var(--gold-main); transform: scale(1.05); transition: transform 0.2s; }

  h2 { margin: 0; font-weight: 600; color: #4a2f33; letter-spacing: 0.12em; font-size: 22px; }
  .card-sub { margin: 8px 0 12px; font-size: 12px; color: rgba(122,78,84,0.9); text-align: center; letter-spacing: 0.04em; transition: font-size 0.3s; }

  .dress-display { margin: 6px 0 16px; display: grid; place-items: center; }
  .dress-wrapper { 
    position: relative; width: 230px; height: 290px; max-width: 100%; 
    cursor: pointer; 
    will-change: transform;
  }
#dressObj { 
  width: 100%; height: 100%; border: 0; display: block; position: relative; z-index: 1; pointer-events: none;
  opacity: 0; 
  transition: opacity 0.3s ease; 
}  #dressImg { width: 100%; height: 100%; display: none; object-fit: contain; position: relative; z-index: 1; pointer-events: none; }

  #pixelDressCanvas { width: 100%; height: 100%; display: none; image-rendering: pixelated; pointer-events: none; }
  body.alt-8bit #pixelDressCanvas { display: block; }
  body.alt-8bit #dressObj,
  body.alt-8bit #dressImg { display: none !important; }

  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 12px; color: #7a4e54; margin-bottom: 6px; letter-spacing: 0.04em; transition: font-size 0.3s; }
  .field input[type="text"] {
    width: 100%; padding: 10px 4px; border-radius: 0; border: none;
    border-bottom: 1px solid rgba(122,78,84,0.5); background: transparent;
    color: #5a3b40; font-size: 16px; outline: none; font-family: "Yu Mincho", serif;
    transition: border-bottom-color 0.3s ease, font-size 0.3s; text-align: center;
    user-select: text; -webkit-user-select: text;
  }
  .field input[type="text"]:focus { border-bottom: 2px solid var(--gold-main); box-shadow: 0 5px 10px -5px rgba(205, 161, 86, 0.3); }

  .slider-group { margin-bottom: 4px; background: rgba(255,242,245,0.96); padding: 10px 10px 4px; border-radius: 14px; border: 1px solid rgba(230,163,175,0.5); box-shadow: inset 0 1px 4px rgba(160,110,120,0.05); }
  .slider-row { display: grid; grid-template-columns: 56px 1fr; column-gap: 8px; align-items: center; margin-bottom: 11px; }
  .slider-row:last-child { margin-bottom: 6px; }
  .slider-label { font-size: 11px; letter-spacing: 0.08em; color: rgba(122,78,84,0.9); width: 56px; white-space: nowrap; font-weight: normal; transition: font-size 0.3s; }
  .slider-value { display: none; }

  input[type="range"] { width: 100%; height: 10px; border-radius: 999px; -webkit-appearance: none; appearance: none; outline: none; cursor: pointer; background: rgba(255,255,255,0.7); border: 1px solid rgba(222,180,184,0.7); touch-action: none; }
  input[type="range"]::-webkit-slider-runnable-track { height: 10px; border-radius: 999px; }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: #ffffff; border: 1px solid rgba(210,145,155,0.9);
    box-shadow: 0 1px 4px rgba(160,110,120,0.45), inset 0 0 0 2px #ffffff, inset 0 0 0 4px rgba(210,145,155,0.5);
    transform: translateY(-7.5px); transition: transform 0.1s ease, box-shadow 0.15s ease, border-color 0.1s ease;
  }
  input[type="range"]:active::-webkit-slider-thumb { transform: translateY(-7.5px) scale(1.1); border-color: var(--gold-main); box-shadow: 0 2px 8px rgba(160,110,120,0.6), inset 0 0 0 2px #ffffff, inset 0 0 0 4px var(--gold-main); }
  
  #hueRange { background: linear-gradient(to right, hsl(0,100%,70%), hsl(60,100%,70%), hsl(120,100%,70%), hsl(180,100%,70%), hsl(240,100%,70%), hsl(300,100%,70%), hsl(360,100%,70%)); }
  #satRange { background: linear-gradient(to right, #e0d5d6, #ff7f7f); }
  #lightRange { background: linear-gradient(to right, #000, #fff); }

  .row { display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1.1fr); gap: 8px; align-items: center; }
  .btn-group { display: flex; gap: 6px; }
  .color-chip-wrapper { position: relative; width: 100%; height: 44px; }
  .color-input { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 1; }
  .color-chip { position: absolute; inset: 0; border-radius: 999px; border: 1px solid rgba(210,170,172,0.9); background: var(--chip-color, #E6A3AF); box-sizing: border-box; box-shadow: 0 1px 2px rgba(140,100,100,0.25), inset 0 0 0 1px rgba(255,255,255,0.6); }

  .btn-main, .btn-ghost { width: 100%; border-radius: 999px; border: none; padding: 11px 14px; font-size: 13px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; outline: none; transition: transform 0.08s ease, box-shadow 0.18s ease, background 0.2s ease, opacity 0.2s ease, font-size 0.3s; font-family: "Yu Mincho", serif; white-space: nowrap; }
  .btn-main { margin-top: 10px; background: #cda156; color: #fffdf5; box-shadow: 0 10px 25px rgba(149,108,67,0.55), 0 0 0 1px rgba(255,255,255,0.95); }
  .btn-main:hover { background: #d6aa5e; transform: translateY(-1px); box-shadow: 0 14px 30px rgba(149,108,67,0.75), 0 0 0 1px rgba(255,255,255,1); }
  .btn-main:active { background: #c3974e; transform: translateY(0); box-shadow: 0 8px 18px rgba(149,108,67,0.6), 0 0 0 1px rgba(255,255,255,0.95); }
  .btn-ghost { height: 44px; background: rgba(255,255,255,0.85); color: #7a4e54; border: 1px solid rgba(210,145,155,0.8); font-size: 11px; padding: 0; }
  .btn-ghost:hover { background: rgba(255,255,255,1); }
  .btn-ghost:active { background: rgba(255,245,247,1); transform: translateY(1px); }
  #keepBtn { border-color: rgba(205, 161, 86, 0.6); color: #8c6a28; background: rgba(255, 252, 240, 0.7); }

  .stock-area { display: flex; justify-content: center; gap: 12px; margin-top: 12px; height: 36px; align-items: center; position: relative; }
  .stock-dot { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(160,110,120,0.3); cursor: pointer; transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); flex-shrink: 0; }
  .stock-dot:active { transform: scale(0.9); }
  .pop-anim { animation: popBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  @keyframes popBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
  .stock-placeholder { font-size: 12px; color: rgba(122,78,84,0.5); letter-spacing: 0.1em; }
  .note { margin-top: 16px; font-size: 11px; color: rgba(122,78,84,0.9); line-height: 1.5; text-align: center; transition: font-size 0.3s; }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(60, 40, 45, 0.5); display: none; place-items: center; 
    z-index: 30000;
    opacity: 0; transition: opacity 0.2s ease; backdrop-filter: blur(5px);
    padding: 24px;
    box-sizing: border-box;
  }
  .modal-overlay.open { display: grid; opacity: 1; }
  .modal {
    background: #fffcfb; width: 100%; max-width: 340px; padding: 40px 28px 32px; border-radius: 24px; text-align: center;
    transform: scale(0.94); transition: transform 0.2s ease; position: relative;
    margin: auto;
  }
  .modal::after {
    content: ""; position: absolute; inset: 12px; border: 2px solid var(--gold-main); border-radius: 16px; pointer-events: none;
  }
  .modal::before {
    content: "CONFIRMATION"; position: absolute; top: 24px; left: 50%; transform: translateX(-50%);
    font-size: 9px; letter-spacing: 0.25em; color: var(--gold-main); font-family: serif; opacity: 0.8; pointer-events: none;
  }
  #gameInviteModal .modal::before {
    content: "SECRET"; 
  }

  .modal-overlay.open .modal { transform: scale(1); }
  .modal h3 { margin: 0 0 20px; font-size: 18px; color: var(--text-main); letter-spacing: 0.15em; font-weight: 600; font-family: "Yu Mincho", serif; border-bottom: 1px solid rgba(205, 161, 86, 0.3); display: inline-block; padding-bottom: 8px; }
  .modal-preview-box { margin: 0 auto 16px; width: 230px; position: relative; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.1)); }
  .modal-guest-info { margin-bottom: 28px; position: relative; z-index: 1; }
  .modal-guest-label { display: block; font-size: 9px; color: var(--gold-main); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 2px; }
  .modal-guest-name { font-size: 20px; color: var(--text-main); font-weight: 600; font-family: "Yu Mincho", serif; display: inline-block; min-width: 140px; padding-bottom: 4px; border-bottom: 1px solid rgba(122,78,84,0.3); }
  .modal-msg { font-size: 12px; color: var(--text-sub); margin-bottom: 24px; font-weight: 500; }
  .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; position: relative; z-index: 2; padding: 0 10px; }
  .modal-btn { padding: 12px 0; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; letter-spacing: 0.1em; font-weight: 600; font-family: "Yu Mincho", serif; transition: all 0.2s ease; }
  .btn-cancel { background: transparent; color: #8a6e72; border: 1px solid rgba(138, 110, 114, 0.4); }
  .btn-cancel:active { background: rgba(138, 110, 114, 0.05); }
  .btn-confirm { background: linear-gradient(135deg, #ddb065, #cda156); color: #fff; box-shadow: 0 4px 15px rgba(205, 161, 86, 0.4); }
  .btn-confirm:active { box-shadow: 0 2px 8px rgba(205, 161, 86, 0.4); transform: translateY(1px); }

  .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(10px); background: rgba(90,59,64,0.95); color: #fff; font-size: 12px; padding: 9px 14px; border-radius: 999px; opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; white-space: nowrap; z-index: 9999; border: 1px solid rgba(255,255,255,0.9); }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .bsod{
    position: fixed;
    inset: 0;
    background:
      repeating-linear-gradient(0deg, rgba(255,255,255,0.06) 0 2px, transparent 2px 6px),
      #0A5BD3;
    color: #fff;
    z-index: 60000;
    display: none;
    padding: 22px 18px;
    font-family: ui-monospace, Menlo, monospace;
  }
  .bsod.show{
    display: block;
  }
  .bsod-inner{
    max-width: 560px;
    margin: 10vh auto 0;
  }
  .bsod-face{
    font-size: 74px;
    font-weight: 900;
    line-height: 1;
    margin: 0 0 16px;
  }
  .bsod-title{
    font-size: 18px;
    font-weight: 900;
    margin: 0 0 10px;
    letter-spacing: .02em;
  }
  .bsod-msg{
    font-size: 14px;
    line-height: 1.7;
    margin: 0 0 14px;
    opacity: 0.95;
  }
  .bsod-sub{
    font-size: 12px;
    margin: 0 0 18px;
    opacity: 0.88;
  }
  .bsod-code{
    font-size: 12px;
    letter-spacing: .08em;
    border-top: 1px solid rgba(255,255,255,0.25);
    padding-top: 10px;
    opacity: 0.92;
    word-break: break-word;
  }

  .game-screen, .ranking-screen {
    position: fixed; inset: 0; 
    background: radial-gradient(circle at center, #2b1f22 0%, #0f080a 100%);
    z-index: 20000;
    display: none; 
    overflow-y: auto; 
    overflow-x: hidden; 
    -webkit-overflow-scrolling: touch;
  }
  
  .game-screen.active, .ranking-screen.active { 
    display: flex; 
    flex-direction: column;
  }

  .scroll-content-wrapper {
    margin: auto;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px 0; 
    min-height: min-content;
  }

  .game-screen::before {
    content: ""; position: fixed; 
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: 
      radial-gradient(circle at 20% 30%, rgba(205, 161, 86, 0.15), transparent 40%),
      radial-gradient(circle at 80% 70%, rgba(230, 163, 175, 0.15), transparent 40%);
    animation: floatLight 15s infinite linear;
    pointer-events: none; z-index: -1;
    will-change: transform;
  }
  @keyframes floatLight { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

  .game-title { 
    font-size: 14px; letter-spacing: 0.15em; color: var(--gold-main); 
    margin-bottom: 20px; 
    font-family: "Yu Mincho", serif;
  }

  .timer-display { 
    font-size: 48px; font-weight: bold; color: #fff; 
    margin-bottom: 10px; font-variant-numeric: tabular-nums; 
    font-family: "Yu Mincho", serif;
    text-shadow: 0 0 15px rgba(255,255,255,0.4);
  }
  
  .score-display { 
    font-size: 24px; color: rgba(255,255,255,0.9); 
    margin-bottom: 20px; font-family: "Yu Mincho", serif;
  }

  .tap-game-btn {
    width: 240px; height: 240px; border-radius: 50%; 
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(8px);
    color: #fff; font-size: 24px; font-weight: bold; letter-spacing: 0.1em;
    box-shadow: 
      0 0 15px rgba(230, 163, 175, 0.25),
      inset 0 0 12px rgba(255,255,255,0.1);
    cursor: pointer; transition: all 0.1s ease;
    display: flex; justify-content: center; align-items: center; flex-direction: column;
    position: relative; overflow: visible;
    -webkit-tap-highlight-color: transparent;
    font-family: "Yu Mincho", serif;
    flex-shrink: 0;
    touch-action: none;
  }
  
  .tap-game-btn:active { 
    transform: scale(0.96); 
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 30px rgba(230, 163, 175, 0.5), inset 0 0 20px rgba(255,255,255,0.3);
  }
  .tap-game-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

  .decoration-wrapper {
    position: relative; width: 220px; height: 220px; margin: 0 auto 16px;
    flex-shrink: 0;
  }
  .energy-ring-deco {
    position: absolute; inset: 0; border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 0 15px rgba(230, 163, 175, 0.2);
    animation: ringBreath 3s ease-in-out infinite;
  }
  .energy-ring-deco::before {
    content: ""; position: absolute; inset: -2px; border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: rgba(205, 161, 86, 0.8);
    border-bottom-color: rgba(205, 161, 86, 0.1);
    animation: ringSpin 8s linear infinite;
  }
  @keyframes ringBreath {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.1); opacity: 0.9; }
  }
  @keyframes ringSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .particle {
    position: absolute; width: 6px; height: 6px; border-radius: 50%;
    background: #fff; pointer-events: none;
    box-shadow: 0 0 6px #fff, 0 0 12px var(--accent);
  }

  .countdown-overlay {
    position: absolute; inset: 0; background: rgba(15,8,10,0.85);
    backdrop-filter: blur(5px);
    display: none; place-items: center; font-size: 80px; 
    color: var(--gold-main); font-weight: bold; z-index: 10;
    font-family: "Yu Mincho", serif;
  }

  #gameResultArea { 
    display: none; flex-direction: column; align-items: center; width: 100%; 
    position: relative; z-index: 10;
  }
  #gameResultArea p { color: rgba(255,255,255,0.8); }

  #gameNameInput { 
    text-align: center; margin-bottom: 12px; padding: 10px; 
    border: 1px solid rgba(255,255,255,0.5); border-radius: 999px; 
    width: 240px; max-width: 240px; box-sizing: border-box;
    font-size: 16px; 
    color: #5a3b40; font-family: "Yu Mincho", serif; background: rgba(255,255,255,0.9); 
  }
  #gameNameInput:focus { border-color: var(--gold-main); background: #fff; outline: none; }

  .btn-game-submit {
    width: 240px; max-width: 240px; box-sizing: border-box;
  }

  .btn-retry {
    background: transparent; color: rgba(255,255,255,0.8);
    border: 1px solid rgba(255,255,255,0.4);
    margin-top: 24px;
    font-size: 12px; padding: 11px 14px;
    width: 240px; max-width: 240px; box-sizing: border-box;
  }
  .btn-retry:active { background: rgba(255,255,255,0.1); }

  .ranking-screen { background: #fdfcf8; color: #5a3b40; } 
  .ranking-list {
    list-style: none; padding: 0; margin: 20px 0; width: 100%; max-width: 340px;
    max-height: 50vh; overflow-y: auto;
  }
  .ranking-item {
    display: grid; grid-template-columns: 40px 1fr 60px; align-items: center;
    padding: 10px 12px; border-bottom: 1px solid rgba(122,78,84,0.1);
    font-size: 14px;
  }
  .rank-badge {
    width: 24px; height: 24px; border-radius: 50%; background: #eee; color: #555;
    display: grid; place-items: center; font-size: 12px; font-weight: bold;
  }
  .rank-1 .rank-badge { background: #cda156; color: #fff; box-shadow: 0 2px 5px rgba(205,161,86,0.4); }
  .rank-2 .rank-badge { background: #a0a0a0; color: #fff; }
  .rank-3 .rank-badge { background: #c49c88; color: #fff; }
  .rank-name { text-align: left; font-weight: 600; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .rank-score { text-align: right; font-weight: bold; color: var(--text-main); }

  .my-score-fixed {
    margin: 0 auto 10px;
    font-weight: bold;
    color: var(--gold-main);
    text-align: center;
    font-family: "Yu Mincho", serif;
    font-size: 16px;
    flex-shrink: 0;
  }

  #discoveryStatus {
    margin-top: 20px;
    font-size: 10px;
    text-align: center;
    color: rgba(122,78,84,0.5);
    letter-spacing: 0.05em;
  }

  .loading-spinner {
    width: 40px; height: 40px; border: 3px solid rgba(205,161,86,0.3);
    border-top-color: var(--gold-main); border-radius: 50%;
    animation: spin 1s linear infinite; margin: 20px auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #hp_container { display: none; visibility: hidden; opacity: 0; position: absolute; left: -9999px; }

</style>
</head>
<body>

<div id="hp_container">
  <label for="honeypot">Please leave this blank</label>
  <input type="text" id="honeypot" name="honeypot" tabindex="-1" autocomplete="off" />
</div>

<div class="card">
  <button id="toggleA11yBtn" class="a11y-toggle" aria-label="ÊñáÂ≠ó„Çµ„Ç§„Ç∫Â§âÊõ¥">
    <div class="a11y-icon-wrapper">
        <span class="a11y-char">„ÅÇ</span>
    </div>
  </button>

  <header class="card-header">
    <p class="tagline">WEDDING COLOR QUIZ</p>
    <h2>„Éâ„É¨„Çπ„ÅÆËâ≤„ÅÇ„Å¶„ÇØ„Ç§„Ç∫</h2>
    <p class="card-sub">
      Ëä±Â´Å„ÅÆ„ÅäËâ≤Áõ¥„Åó„ÅÆ„Éâ„É¨„Çπ„ÅØ‰ΩïËâ≤„Åß„Åó„Çá„ÅÜÔºü<br>
      „Äå„Åì„Çå„Å†ÔºÅ„Äç„Å®ÊÄù„ÅÜËâ≤„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
    </p>
  </header>

  <div class="dress-display">
    <div class="dress-wrapper" id="dressWrapper" data-mode="auto">
      <object id="dressObj" type="image/svg+xml" data="file.svg" aria-label="dress"></object>
      <img id="dressImg" src="file.svg" alt="dress" />
      <canvas id="pixelDressCanvas" class="pixel-dress" aria-hidden="true"></canvas>
    </div>
  </div>

  <div class="field">
    <label>„Éê„Éº„ÅßËâ≤„ÇíÁ¥∞„Åã„ÅèË™øÊï¥</label>
    <div class="slider-group">
      <div class="slider-row">
        <span class="slider-label">Ëâ≤„ÅÇ„ÅÑ</span>
        <input type="range" id="hueRange" min="0" max="360" value="0" aria-label="Ëâ≤Âêà„ÅÑ" />
        <span class="slider-value" id="hueValue">0¬∞</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">ÈÆÆ„ÇÑ„Åã„Åï</span>
        <input type="range" id="satRange" min="0" max="100" value="50" aria-label="ÈÆÆ„ÇÑ„Åã„Åï" />
        <span class="slider-value" id="satValue">50%</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Êòé„Çã„Åï</span>
        <input type="range" id="lightRange" min="0" max="100" value="70" aria-label="Êòé„Çã„Åï" />
        <span class="slider-value" id="lightValue">70%</span>
      </div>
    </div>
  </div>

  <div class="field">
    <label>Ëâ≤Ë¶ãÊú¨„Éª„Åä„Åæ„Åã„Åõ„Éª„Ç≠„Éº„Éó</label>
    <div class="row">
      <div class="color-chip-wrapper">
        <input type="color" id="colorInput" class="color-input" value="#ccd3ff" />
        <div id="colorChip" class="color-chip"></div>
      </div>
      <div class="btn-group">
        <button id="randomBtn" class="btn-ghost" style="flex:1;">„Åä„Åæ„Åã„Åõ</button>
        <button id="keepBtn" class="btn-ghost" style="flex:1;">„Ç≠„Éº„Éó</button>
      </div>
    </div>
    <div id="stockArea" class="stock-area">
      <span class="stock-placeholder">Ê∞ó„Å´„Å™„ÇãËâ≤„Çí„Åì„Åì„Å´„Ç≠„Éº„Éó!</span>
    </div>
  </div>

  <div style="margin-top: 20px;">
    <p class="input-guide" style="margin-bottom:8px; font-size:12px; color:rgba(122,78,84,0.8); text-align:center; letter-spacing:0.05em;">
      <span style="opacity:0.7;">üñäÔ∏è</span> ÊúÄÂæå„Å´„ÄÅ„ÅäÂêçÂâç„ÇíÊ∑ª„Åà„Å¶ÊäïÁ•®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    </p>
    
    <div class="field">
      <label for="nameInput" style="display:flex; align-items:center; gap:6px;">
      </label><input type="text" id="nameInput" placeholder="‰æãÔºâÂ±±Áî∞Ëä±Â≠ê" maxlength="10" />
    </div>
  </div>

  <button id="submitBtn" class="btn-main">„Åì„ÅÆËâ≤„ÅßÊäïÁ•®„Åô„Çã</button>
  <div class="note">
    „Äå„ÅäÂêçÂâç„Äç„Å®„ÄåÈÅ∏„Çì„Å†Ëâ≤„Äç„ÅåË®òÈå≤„Åï„Çå„Åæ„Åô„ÄÇ<br />
    Ë§áÊï∞ÂõûÈÄÅ‰ø°„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅÊúÄÊñ∞„ÅÆ„ÇÇ„ÅÆ„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
  </div>

  <div id="modeReturnLink" class="mode-return" style="display:none;"><span class="mode-return-text">ÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Çã</span></div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3>ÊäïÁ•®ÂÜÖÂÆπ„ÅÆÁ¢∫Ë™ç</h3>
    <div class="modal-content" id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn btn-cancel" id="cancelSendBtn">Êàª„Çã</button>
      <button class="modal-btn btn-confirm" id="finalSendBtn">ÈÄÅ‰ø°„Åô„Çã</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="colorPreviewModal">
  <div class="modal">
    <h3>„Éâ„É¨„Çπ„Éó„É¨„Éì„É•„Éº</h3>
    <div class="modal-content" id="colorPreviewBody"></div>
    <div class="modal-actions" style="grid-template-columns: 1fr;">
      <button class="modal-btn btn-confirm" id="colorPreviewCloseBtn">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="gameInviteModal">
  <div class="modal">
    <h3>Èö†„Åó„É¢„Éº„ÉâÁô∫Ë¶ãÔºÅ</h3>
    <p class="modal-msg" style="margin-top:16px; line-height: 1.8;">
      ÈÄ£Êâì„Éü„Éã„Ç≤„Éº„É†„Å´ÊåëÊà¶„Åó„Åæ„Åô„ÅãÔºü<br>
      5ÁßíÈñì„Åß‰ΩïÂõû„Çø„ÉÉ„Éó„Åß„Åç„Çã„ÅãÁ´∂‰∫âÔºÅ<br>
      <span style="font-size: 85%; opacity: 0.9;">Ôºà1‰Ωç„Å†„Å®ÊôØÂìÅ„Åå„ÅÇ„Çã‚Ä¶„Åã„ÇÇÔºüÔºâ</span>
    </p>
    <p style="font-size: 11px; color: #999; margin-bottom: 24px;">
        ‚Äª„Ç≤„Éº„É†ÁµÇ‰∫ÜÂæå„ÄÅÂÖÉ„ÅÆÁîªÈù¢„Å´Êàª„Å£„Å¶ÊäïÁ•®„Åß„Åç„Åæ„Åô
    </p>
    <div class="modal-actions">
      <button class="modal-btn btn-cancel" id="gameDeclineBtn">„ÇÑ„Çâ„Å™„ÅÑ</button>
      <button class="modal-btn btn-confirm" id="gameAcceptBtn">ÊåëÊà¶„Åô„ÇãÔºÅ</button>
    </div>
  </div>
</div>

<div class="game-screen" id="gameScreen">
  <div class="scroll-content-wrapper">
    <div class="countdown-overlay" id="gameCountdown">3</div>
    <div class="game-title">5ÁßíÈÄ£Êâì„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</div>
    <div class="timer-display" id="gameTimer">3.00</div>
    <div class="score-display">SCORE: <span id="gameScore">0</span></div>
    
    <button class="tap-game-btn" id="tapGameBtn" disabled>
      <span id="tapBtnText">WAIT</span>
    </button>
  
    <div id="gameResultArea">
      <div class="decoration-wrapper">
        <div class="energy-ring-deco"></div>
      </div>
      
      <p style="font-size:12px; margin-bottom:8px;">ÂêçÂâç„ÇÇ„Åó„Åè„ÅØ„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„É©„É≥„Ç≠„É≥„Ç∞„Å∏</p>
      <input type="text" id="gameNameInput" placeholder="‰æãÔºâÂ±±Áî∞Ëä±Â≠ê" maxlength="10" />
      <button id="gameSubmitBtn" class="btn-main btn-game-submit">„É©„É≥„Ç≠„É≥„Ç∞ÁôªÈå≤</button>
      
      <button id="retryGameBtn" class="btn-ghost btn-retry">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button>
      
      <p id="skipRegisterBtn" style="margin-top: 16px; font-size: 12px; text-decoration: underline; color: rgba(255,255,255,0.6); cursor: pointer; letter-spacing: 0.05em;">
        ÁôªÈå≤„Åõ„Åö„Å´„É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã
      </p>
      </div>
    <div id="gameRecaptcha" style="display:none;"></div>
    </div>
</div>

<div class="ranking-screen" id="rankingScreen">
  <div class="scroll-content-wrapper">
    <h3>TODAY'S RANKING</h3>
    <div id="myScoreDisplay" class="my-score-fixed"></div>

  <div id="colorRankingInfo"
      class="color-ranking-info"
      style="display:none; font-size:11px; margin-bottom:8px; color:rgba(0,0,0,0.75);">
  </div>

    <div id="rankingListContainer" class="ranking-list">
      <div class="loading-spinner"></div>
    </div>

    <button class="btn-ghost" id="rankRetryBtn" style="margin-bottom:12px; max-width:200px;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button>
    
    <button class="btn-main" id="backToMainBtn" style="max-width:200px;">Êàª„Çã</button>
    
    <div id="colorDistanceInfo"
         class="color-distance-info"
         style="display:none; font-size:11px; margin:8px 0 4px; color:rgba(0,0,0,0.75); text-align:center;">
    </div>

    <div id="discoveryStatus"></div>

    <div id="modeReturnLinkRank" class="mode-return" style="display:none;"><span class="mode-return-text">ÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Çã</span></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">ÊäïÁ•®„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü</div>

<div id="bsodOverlay" class="bsod" aria-hidden="true">
  <div class="bsod-inner">
    <div class="bsod-face">:(</div>
    <div class="bsod-title">„Ç∑„Çπ„ÉÜ„É†„ÅåÂïèÈ°å„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü</div>
    <div class="bsod-msg">
      Á´ØÊú´„Çí‰øùË≠∑„Åô„Çã„Åü„ÇÅÂÖ•Âäõ„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü„ÄÇ<br>
      Êï∞ÁßíÂæå„Å´Ëá™Âãï„ÅßÂæ©Â∏∞„Åó„Åæ„Åô„ÄÇ
    </div>
    <div class="bsod-sub">
      ‚Äª„Åì„Çå„ÅØ„Ç∏„Éß„Éº„ÇØË°®Á§∫„Åß„Åô„ÄÇÁ´ØÊú´„ÇÑ„Éá„Éº„Çø„Å´ÂΩ±Èüø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
    </div>
    <div class="bsod-code">
      STOP CODE: DRESS_DEBUG_DETECTED
    </div>
  </div>
</div>

<script>
(function(){
  document.addEventListener('contextmenu', e => { e.preventDefault(); return false; }, {passive: false});

  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || 
       (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S')) ||
       (e.ctrlKey && e.shiftKey && (e.key === 'i' || e.key === 'I' || e.key === 'c' || e.key === 'C' || e.key === 'j' || e.key === 'J'))) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }, {capture: true});

  document.addEventListener('dragstart', e => { e.preventDefault(); return false; });

  setInterval(function(){
    (function(){}).constructor("debugger")();
  }, 500);
})();
  const KEEP_KEYS = ['dress_game_discoveries']; 

  try {
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('dress_') && !KEEP_KEYS.includes(key)) {
      localStorage.removeItem(key);
    }
  });
  } catch(e) { /* localStorage unavailable */ }

  const toggleA11yBtn = document.getElementById('toggleA11yBtn');
  
  toggleA11yBtn.addEventListener('click', () => {
    document.body.classList.toggle('large-mode');
    triggerHaptic('light');
  });

  let isVisualUpdatePending = false;
  let pendingH = 0, pendingS = 0, pendingL = 0;
  let pendingHex = "";
  
  let gameRecaptchaWidgetId = null;
  let pendingGameSubmit = null;
  let recaptchaFallbackTimer = null;

  function onGameRecaptchaLoad() {
    if (!window.grecaptcha) return;
    gameRecaptchaWidgetId = grecaptcha.render('gameRecaptcha', {
      sitekey: '6LfPqxcsAAAAAPeYLBqjvMKiwO1IT15jOLvzJ_Mr',
      size: 'invisible',
      callback: onGameRecaptchaSuccess
    });
  }

  function onGameRecaptchaSuccess(token) {
    if (!pendingGameSubmit) return;
    if (recaptchaFallbackTimer !== null) {
      clearTimeout(recaptchaFallbackTimer);
      recaptchaFallbackTimer = null;
    }
    const { score, name } = pendingGameSubmit;
    pendingGameSubmit = null;
    submitAndShowRankingWithToken(score, name, token);
  }

  function sanitizeInput(str) {
    if (!str) return "";
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function hexToRgb(hex){
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : null;
  }

  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2;
    if(max===min){
      h=s=0;
    } else {
      const d=max-min;
      s=l>0.5? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d+(g<b?6:0); break;
        case g: h=(b-r)/d+2; break;
        case b: h=(r-g)/d+4; break;
      }
      h/=6;
    }
    return {h:h*360, s, l};
  }

  function hslToHex(h,s,l){
    h/=360;
    const hue2rgb=(p,q,t)=>{
      if(t<0) t+=1; if(t>1) t-=1;
      if(t<1/6) return p+(q-p)*6*t;
      if(t<1/2) return q;
      if(t<2/3) return p+(q-p)*(2/3-t)*6;
      return p;
    };
    let r,g,b;
    if(s===0){ r=g=b=l; }
    else{
      const q=l<0.5? l*(1+s) : l+s-l*s;
      const p=2*l-q;
      r=hue2rgb(p,q,h+1/3);
      g=hue2rgb(p,q,h);
      b=hue2rgb(p,q,h-1/3);
    }
    const toHex=v=>Math.round(v*255).toString(16).padStart(2,'0');
    return '#'+toHex(r)+toHex(g)+toHex(b);
  }

  function clamp01(x){ return x < 0 ? 0 : x > 1 ? 1 : x; }

  const dressWrapper = document.getElementById('dressWrapper');
  const dressObj     = document.getElementById('dressObj');
  const dressImg     = document.getElementById('dressImg');
  const pixelDressCanvas = document.getElementById('pixelDressCanvas');

  const colorInput   = document.getElementById('colorInput');
  const colorChip    = document.getElementById('colorChip');
  const hueRange     = document.getElementById('hueRange');
  const satRange     = document.getElementById('satRange');
  const lightRange   = document.getElementById('lightRange');

  const hueValue     = document.getElementById('hueValue');
  const satValue     = document.getElementById('satValue');
  const lightValue   = document.getElementById('lightValue');
  const colorHexLabel= document.getElementById('colorHexLabel');

  const submitBtn    = document.getElementById('submitBtn');
  const randomBtn    = document.getElementById('randomBtn');
  const keepBtn      = document.getElementById('keepBtn');
  const stockArea    = document.getElementById('stockArea');
  const nameInput    = document.getElementById('nameInput');
  const toast        = document.getElementById('toast');
  const honeypot     = document.getElementById('honeypot');

  const modeReturnLink = document.getElementById('modeReturnLink');
  const modeReturnLinkRank = document.getElementById('modeReturnLinkRank');

  function returnToNormalMode(){
    if (!document.body.classList.contains('alt-8bit')) return;
    setAltMode(false);
    showToast('MODE: NORMAL');
  }

  if (modeReturnLink) modeReturnLink.addEventListener('click', returnToNormalMode);
  if (modeReturnLinkRank) modeReturnLinkRank.addEventListener('click', returnToNormalMode);

  const pixelStage   = document.getElementById('pixelStage');
  const pixelCanvas  = document.getElementById('pixelCanvas');
  const bsodOverlay  = document.getElementById('bsodOverlay');

  const confirmModal = document.getElementById('confirmModal');
  const modalBody    = document.getElementById('modalBody');
  const cancelSendBtn= document.getElementById('cancelSendBtn');
  const finalSendBtn = document.getElementById('finalSendBtn');

  const colorPreviewModal = document.getElementById('colorPreviewModal');
  const colorPreviewBody = document.getElementById('colorPreviewBody');
  const colorPreviewCloseBtn = document.getElementById('colorPreviewCloseBtn');

  let colorPreviewPrevColor = null;

  function closeColorPreview(){
    if (!colorPreviewModal) return;
    colorPreviewModal.classList.remove('open');
    if (colorPreviewPrevColor) {
      initColor(colorPreviewPrevColor);
      colorPreviewPrevColor = null;
    }
  }

  if (colorPreviewCloseBtn) colorPreviewCloseBtn.addEventListener('click', closeColorPreview);
  if (colorPreviewModal) {
    colorPreviewModal.addEventListener('click', (e) => {
      if (e.target === colorPreviewModal) closeColorPreview();
    });
  }

  function parseRgbString(str) {
    if (!str) return null;
    const s = String(str).trim();

    const mhex = /^#?([0-9a-f]{6})$/i.exec(s);
    if (mhex) {
      const hex = '#' + mhex[1];
      const rgb = hexToRgb(hex);
      if (rgb) return rgb;
    }

    const parts = s.split(',').map(p => p.trim()).filter(p => p.length);
    if (parts.length < 3) return null;

    const nums = parts.slice(0,3).map(n => parseInt(n, 10));
    if (nums.some(n => !Number.isFinite(n))) return null;

    const [r,g,b] = nums;
    if (r < 0 || r > 255 || g < 0 || g > 255 || b < 0 || b > 255) return null;

    return { r, g, b };
  }

  function waitFrames(n){
    return new Promise(resolve => {
      let c = 0;
      function tick(){
        c++;
        if (c >= n) resolve();
        else requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  async function showDressPreviewModal(displayName, colorStr){
    if (!colorPreviewModal || !colorPreviewBody) return;

    const rgb = parseRgbString(colorStr);
    if (!rgb) return;

    const toHex = v => Math.round(v).toString(16).padStart(2,'0');
    const hex = '#' + toHex(rgb.r) + toHex(rgb.g) + toHex(rgb.b);

    if (!colorPreviewPrevColor) colorPreviewPrevColor = currentColor;
    initColor(hex);
    await waitFrames(2);

    colorPreviewBody.innerHTML = '';
    const previewContainer = document.createElement('div');
    previewContainer.className = 'modal-preview-box';

    if (dressWrapper.dataset.mode === 'direct') {
      const svgDoc = dressObj.contentDocument;
      const originalSvg = svgDoc && svgDoc.querySelector('svg');
      if (originalSvg) {
        const cloneSvg = originalSvg.cloneNode(true);
        cloneSvg.removeAttribute('width'); cloneSvg.removeAttribute('height');
        cloneSvg.style.width = '100%'; cloneSvg.style.height = 'auto'; cloneSvg.style.display = 'block';
        cloneSvg.style.filter = 'drop-shadow(0 10px 10px rgba(0,0,0,0.15))';
        previewContainer.appendChild(cloneSvg);
      }
    } else {
      const imgClone = dressImg.cloneNode(true);
      imgClone.style.display = 'block'; imgClone.style.width = '100%'; imgClone.style.height = 'auto';
      imgClone.style.filter = dressImg.style.filter + ' drop-shadow(0 10px 10px rgba(0,0,0,0.15))';
      previewContainer.appendChild(imgClone);
    }

    colorPreviewBody.appendChild(previewContainer);

  if (displayName !== 'Ê≠£Ëß£„ÅÆ„Éâ„É¨„Çπ') {
    const guestInfoDiv = document.createElement('div');
    guestInfoDiv.className = 'modal-guest-info';

    const labelSpan = document.createElement('span');
    labelSpan.className = 'modal-guest-label';
    labelSpan.textContent = 'GUEST';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'modal-guest-name';
    nameDiv.textContent = displayName + ' Êßò';

    guestInfoDiv.appendChild(labelSpan);
    guestInfoDiv.appendChild(nameDiv);
    colorPreviewBody.appendChild(guestInfoDiv);
  }

    colorPreviewModal.classList.add('open');
  }

  const gameInviteModal = document.getElementById('gameInviteModal');
  const gameDeclineBtn = document.getElementById('gameDeclineBtn');
  const gameAcceptBtn = document.getElementById('gameAcceptBtn');
  const gameScreen = document.getElementById('gameScreen');
  const gameCountdown = document.getElementById('gameCountdown');
  const gameTimer = document.getElementById('gameTimer');
  const gameScore = document.getElementById('gameScore');
  const tapGameBtn = document.getElementById('tapGameBtn');
  const tapBtnText = document.getElementById('tapBtnText');
  const gameResultArea = document.getElementById('gameResultArea');
  const gameNameInput = document.getElementById('gameNameInput');
  const gameSubmitBtn = document.getElementById('gameSubmitBtn');
  const retryGameBtn = document.getElementById('retryGameBtn'); 
  const rankingScreen = document.getElementById('rankingScreen');
  const rankingListContainer = document.getElementById('rankingListContainer');
  const backToMainBtn = document.getElementById('backToMainBtn');
  const myScoreDisplay = document.getElementById('myScoreDisplay');
  const skipRegisterBtn = document.getElementById('skipRegisterBtn');
  const rankRetryBtn = document.getElementById('rankRetryBtn');

  const COLORS = ['#ccd3ff','#A7C7E7','#C2DEDC','#F2D1C9','#E53B3B'];
  const MAX_NAME_LENGTH = 10;
  const RATE_LIMIT_KEY = 'dress_rate_limit';
  const RATE_LIMIT_MAX = 5;
  const RATE_LIMIT_WINDOW_MS = 15*60*1000;
  const RATE_LIMIT_MIN_INTERVAL_MS = 10*1000;

  const CLIENT_ID_KEY = 'dress_client_id';
  let CLIENT_ID = null;
  try {
    CLIENT_ID = localStorage.getItem(CLIENT_ID_KEY);
    if (!CLIENT_ID) {
      if (self.crypto && crypto.randomUUID) {
        CLIENT_ID = crypto.randomUUID();
      } else {
        CLIENT_ID = Date.now().toString(36) + '_' + Math.random().toString(16).slice(2);
      }
      localStorage.setItem(CLIENT_ID_KEY, CLIENT_ID);
    }
  } catch(e){ CLIENT_ID = 'unknown'; }

  let currentColor = COLORS[0];
  let currentL = 0.7;
  let hasInteracted = false; 

  let directParts = [];
  let baseAvgL = 0, baseAvgS = 0;
  let minOrigL = 0, maxOrigL = 1;

  function tryWireSvgDirect(){
    try {
      const doc = dressObj.contentDocument;
      if (!doc) return false;
      void doc.documentElement.getBBox();
      const root = doc.getElementById('dress');
      if (!root) return false;

      const elems = Array.from(root.querySelectorAll('path,polygon,circle,ellipse,use'));
      if (!elems.length) return false;

      const colored = [];
      let sumL = 0;
      let sumS = 0;
      let localMinL = 1;
      let localMaxL = 0;

      elems.forEach(el => {
        let fill = el.getAttribute('fill') || '';
        if (!fill || fill === 'none' || fill.startsWith('url(')) {
          const cs = doc.defaultView.getComputedStyle(el);
          fill = (cs && cs.fill) || '';
        }
        let hsl = null;
        if (/^#([0-9a-f]{6})$/i.test(fill)) {
          const rgb = hexToRgb(fill);
          hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        } else if (/^rgb\(/i.test(fill)) {
          const nums = fill.replace(/[^\d,]/g, '').split(',').map(x => parseInt(x,10));
          if (nums.length >= 3) hsl = rgbToHsl(nums[0], nums[1], nums[2]);
        }
        if (hsl) {
          el.__origHSL = hsl;
          colored.push({el, hsl});
          sumL += hsl.l;
          sumS += hsl.s;
          if (hsl.l < localMinL) localMinL = hsl.l;
          if (hsl.l > localMaxL) localMaxL = hsl.l;
        }
      });

      if (!colored.length) return false;
      directParts = colored.map(c => c.el);
      baseAvgL = sumL / colored.length;
      baseAvgS = sumS / colored.length;
      minOrigL = localMinL;
      maxOrigL = localMaxL;
      directParts.forEach(el => { el.style.transition = 'fill .12s ease'; });
      dressWrapper.dataset.mode = 'direct';
      dressObj.style.display = 'block';
      dressImg.style.display = 'none';
      return true;
    } catch(e){ return false; }
  }

  function enableFallback(){
    dressWrapper.dataset.mode = 'fallback';
    dressObj.style.display = 'none';
    dressImg.style.display = 'block';
    dressImg.style.filter = 'none';
  }

  function requestVisualUpdate(h, s, l, hex) {
    pendingH = h;
    pendingS = s;
    pendingL = l;
    pendingHex = hex;
    
    if (!isVisualUpdatePending) {
      isVisualUpdatePending = true;
      requestAnimationFrame(processVisualUpdate);
    }
  }

  function processVisualUpdate() {
    isVisualUpdatePending = false;
    
    const sPercent = clamp01(pendingS) * 100;
    const lPercent = clamp01(pendingL) * 100;

    const satStart = `hsl(${pendingH}, 0%, ${lPercent}%)`;
    const satEnd   = `hsl(${pendingH}, 100%, ${lPercent}%)`;
    satRange.style.background = `linear-gradient(to right, ${satStart}, ${satEnd})`;

    const lightStart = `hsl(${pendingH}, ${sPercent}%, 0%)`;
    const lightMid   = `hsl(${pendingH}, ${sPercent}%, 50%)`;
    const lightEnd   = `hsl(${pendingH}, ${sPercent}%, 100%)`;
    lightRange.style.background = `linear-gradient(to right, ${lightStart}, ${lightMid}, ${lightEnd})`;

    if (hueValue)   hueValue.textContent   = `${Math.round(pendingH)}¬∞`;
    if (satValue)   satValue.textContent   = `${Math.round(sPercent)}%`;
    if (lightValue) lightValue.textContent = `${Math.round(lPercent)}%`;

    if (colorChip) colorChip.style.background = pendingHex;
    const rgb = hexToRgb(pendingHex);
    if (rgb) {
        document.documentElement.style.setProperty('--accent', pendingHex);
        document.documentElement.style.setProperty('--accent-soft', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.95)`);
    }

    if (document.body.classList.contains('alt-8bit')) {
        update8bitTheme(pendingHex);
        drawPixelDress(pendingH, pendingS, pendingL);
    }

    const mode = dressWrapper.dataset.mode;
    if (mode === 'direct') {
      applyDirectSVGColor(pendingHex, pendingS, pendingL, pendingH);
    } else if (mode === 'fallback') {
      applyFallbackFilter(pendingS, pendingL, pendingH);
    }
  }

  function applyDirectSVGColor(hex, S0, L0, H0) {
      const rgb = hexToRgb(hex);
      if(!rgb) return;
      
      const rangeOrigL = Math.max(1e-4, maxOrigL - minOrigL);
      const greyLevel  = clamp01((0.12 - S0) / 0.12);
      const edgeDark   = clamp01((0.08 - L0) / 0.08);
      const edgeLight  = clamp01((L0 - 0.92) / 0.08);

      const contrastBase = 0.45;
      const contrastS = 0.6 + 0.4 * (1 - S0);
      const contrastL = 0.8 + 0.2 * (1 - 4 * (L0 - 0.5) * (L0 - 0.5));
      let contrast = contrastBase * contrastS * contrastL;
      const edgeBoost = 1 + 0.3 * (edgeDark + edgeLight);
      contrast *= edgeBoost;

      const floorBase = 0.05 + 0.25 * S0;
      const ceilBase  = 0.95 - 0.20 * S0;

      let floor = (1 - edgeDark) * floorBase + edgeDark * 0.0;
      let ceil  = (1 - edgeLight) * ceilBase + edgeLight * 1.0;

      if (ceil < floor + 0.02) {
        const mid = (floor + ceil) / 2;
        floor = Math.max(0, mid - 0.01);
        ceil  = Math.min(1, mid + 0.01);
      }

      directParts.forEach(el => {
        const orig = el.__origHSL || {h:0,s:0,l:0};
        let t = (orig.l - minOrigL) / rangeOrigL;
        t = clamp01(t);

        const offsetTone = (t - 0.5) * contrast;
        let newL = L0 + offsetTone;
        if (newL < floor) newL = floor;
        if (newL > ceil)  newL = ceil;

        const ratioS = baseAvgS > 1e-6 ? orig.s / baseAvgS : 1.0;
        const satEffect = 0.2 * (1 - greyLevel);
        let newS = S0 * (1 + (ratioS - 1) * satEffect);

        const minSat = S0 * (0.6 + 0.3 * (1 - greyLevel));
        const maxSat = Math.min(1, S0 * (1.1 + 0.3 * (1 - greyLevel)));
        if (newS < minSat) newS = minSat;
        if (newS > maxSat) newS = maxSat;

        const newHex = hslToHex(H0, newS, newL);
        el.setAttribute('fill', newHex);
      });
  }


  function setupPixelDressCanvas(){
    if (!pixelDressCanvas) return;
    pixelDressCanvas.width = 72;
    pixelDressCanvas.height = 90;
    const ctx = pixelDressCanvas.getContext('2d');
    if (ctx) ctx.imageSmoothingEnabled = false;
  }

  function clearPixelDress(){
    if (!pixelDressCanvas) return;
    const ctx = pixelDressCanvas.getContext('2d');
    if (!ctx) return;
    ctx.clearRect(0, 0, pixelDressCanvas.width, pixelDressCanvas.height);
  }

function drawPixelDress(H0, S0, L0){
    if (!pixelDressCanvas) return;
    const ctx = pixelDressCanvas.getContext('2d');
    if (!ctx) return;

    const W = pixelDressCanvas.width;
    const H = pixelDressCanvas.height;
    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0, 0, W, H);

    const colBase      = hslToHex(H0, clamp01(S0), clamp01(L0));
    const colHigh      = hslToHex(H0, clamp01(S0 * 0.9), clamp01(L0 + 0.15));
    const colHigh2     = hslToHex(H0, clamp01(S0 * 0.8), clamp01(L0 + 0.25));
    const colShadow    = hslToHex(H0, clamp01(S0 * 1.1), clamp01(L0 - 0.12));
    const colDeep      = hslToHex(H0, clamp01(S0 * 1.2), clamp01(L0 - 0.25));
    
    const colOutline   = (L0 > 0.65) ? 'rgba(60,40,45,0.6)' : 'rgba(234,255,246,0.5)';
    const colLace      = (L0 > 0.65) ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.3)';

    const cx = Math.floor(W / 2);
    const halfWAtY = new Array(H).fill(0);

    const bodiceTop = 14;
    const waistY = 32;
    const skirtEnd = H - 10;

    for (let y = 0; y < H; y++){
      let halfW = 0;
      
      if (y >= bodiceTop && y < waistY){
        const t = (y - bodiceTop) / (waistY - bodiceTop);
        halfW = 10 - t * 2.5; 
      } 
      else if (y >= waistY && y <= skirtEnd){
        const t = (y - waistY) / (skirtEnd - waistY);
        
        halfW = 7.5 + (t * t * 15) + (t * 5);
      }
      
      halfWAtY[y] = Math.round(halfW);
    }

    for (let y = 0; y < H; y++){
      const hw = halfWAtY[y];
      if (hw <= 0) continue;

      const leftX  = cx - hw;
      const rightX = cx + hw;

      for (let x = leftX; x <= rightX; x++){
        if (y === skirtEnd) {
            const wave = Math.sin(x * 0.45) * 1.2; 
            if (wave > 0) continue;
        }

        if (y < bodiceTop + 3) {
             const neckCurve = Math.abs(x - cx) * 0.6;
             if (y < bodiceTop + 3 - neckCurve) continue;
        }

        const isEdge = (x === leftX || x === rightX);
        if (isEdge) {
            ctx.fillStyle = colOutline;
            ctx.fillRect(x, y, 1, 1);
            continue;
        }

        const xd = (x - cx) / hw; 
        const foldFreq = 0.5 - (y - waistY) * 0.003; 
        const foldVal = Math.sin((x - cx) * Math.max(0.1, foldFreq)); 

        let finalColor = colBase;

        if (xd < -0.4) finalColor = colHigh;
        else if (xd > 0.4) finalColor = colShadow;

        if (y > waistY + 2) {
             if (foldVal > 0.6) {
                 finalColor = (finalColor === colShadow) ? colBase : colHigh;
             } else if (foldVal < -0.6) {
                 finalColor = (finalColor === colHigh) ? colBase : colDeep;
             }
        }

        const dither = ((x + y) & 1) === 0;
        if (y > waistY && y < waistY + 20 && xd < -0.5 && xd > -0.8 && dither) {
            finalColor = colHigh2;
        }
        if (xd > 0.7 && dither) {
            finalColor = colDeep;
        }
        if (y === waistY || y === waistY + 1) {
            finalColor = colShadow;
        }

        ctx.fillStyle = finalColor;
        ctx.fillRect(x, y, 1, 1);
      }
    }

    ctx.fillStyle = colLace;
    for (let x = cx - halfWAtY[skirtEnd]; x <= cx + halfWAtY[skirtEnd]; x += 3){
         if ((x + skirtEnd) % 2 === 0) {
             ctx.fillRect(x, skirtEnd - 2, 1, 1);
             ctx.fillRect(x + 1, skirtEnd - 1, 1, 1);
         }
    }

    const sparkles = [
      {x: cx - 5,  y: waistY + 10},
      {x: cx + 8,  y: waistY + 25},
      {x: cx - 10, y: skirtEnd - 15}, 
      {x: cx + 3,  y: skirtEnd - 8},
      {x: cx - 2,  y: bodiceTop + 6}
    ];

    sparkles.forEach(p => {
       if (p.y < H && Math.abs(p.x - cx) < halfWAtY[p.y]) {
           ctx.fillStyle = 'rgba(255,255,255,0.9)';
           ctx.fillRect(p.x, p.y, 1, 1);
           ctx.fillStyle = 'rgba(255,255,255,0.5)';
           ctx.fillRect(p.x - 1, p.y, 3, 1);
           ctx.fillRect(p.x, p.y - 1, 1, 3);
       }
    });
  }
  function applyFallbackFilter(s, l, h) {
      if (s < 0.05) {
        const brightness = 0.4 + 1.2 * l;
        dressImg.style.filter = `grayscale(1) brightness(${brightness})`;
      } else {
        const hueRotate = h;
        const sat = 0.6 + s;
        let brightness;
        if (s >= 0.7) {
          brightness = 0.9 + (l - 0.5) * 0.5;
        } else {
          brightness = 0.85 + (l - 0.5) * 0.7;
        }
        dressImg.style.filter = `hue-rotate(${hueRotate}deg) saturate(${sat}) brightness(${brightness})`;
      }
  }

  function onSliderInput() {
    hasInteracted = true;
    const h = parseFloat(hueRange.value);
    const s = parseFloat(satRange.value) / 100;
    const l = parseFloat(lightRange.value) / 100;
    const hex = hslToHex(h, s, l);
    
    currentColor = hex;
    currentL = l;
    
    if (colorHexLabel) colorHexLabel.textContent = hex.toUpperCase();
    if (colorInput && document.activeElement !== colorInput) {
        colorInput.value = hex;
    }
    
    requestVisualUpdate(h, s, l, hex);
  }

  if (colorInput) {
    colorInput.addEventListener('input', e => {
      hasInteracted = true;
      const hex = e.target.value;
      const rgb = hexToRgb(hex);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        hueRange.value = hsl.h;
        satRange.value = hsl.s * 100;
        lightRange.value = hsl.l * 100;
        currentColor = hex;
        currentL = hsl.l;
        requestVisualUpdate(hsl.h, hsl.s, hsl.l, hex);
      }
    });
  }

  hueRange.addEventListener('input', onSliderInput, {passive: true});
  satRange.addEventListener('input', onSliderInput, {passive: true});
  lightRange.addEventListener('input', onSliderInput, {passive: true});

  function initColor(hex) {
    currentColor = hex;
    if (colorInput) colorInput.value = hex;
    const rgb = hexToRgb(hex);
    if(rgb){
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        hueRange.value = hsl.h;
        satRange.value = hsl.s * 100;
        lightRange.value = hsl.l * 100;
        currentL = hsl.l;
        requestVisualUpdate(hsl.h, hsl.s, hsl.l, hex);
    }
  }

  let lastActionWasRandom = false;
  let omakaseKeepCombo = 0;
  let omakaseTapCount = 0;
  let omakaseTapTimer = null;

  randomBtn.addEventListener('click', () => {
    hasInteracted = true;
    const h = Math.random() * 360;
    const s = 0.4 + Math.random() * 0.5;
    const l = 0.6 + Math.random() * 0.3;
    const hex = hslToHex(h, s, l);
    
    initColor(hex);
    
    lastActionWasRandom = true;
    omakaseTapCount++;
    if (omakaseTapTimer) clearTimeout(omakaseTapTimer);
    omakaseTapTimer = setTimeout(() => { omakaseTapCount = 0; }, 10000);
    if (omakaseTapCount >= 13) {
      omakaseTapCount = 0;
      resetTriggerCounters();
      triggerGameInvite('random');
    }
  });

  let keepTapCount = 0;
  const GAME_BAN_KEY = 'dress_game_ban_until';
  const PERMANENT_BAN_KEY = 'dress_game_permanent_ban';
  const SUPPRESS_CONFIRM_KEY = 'dress_game_suppress_confirm';
  let declineCount = 0;

  keepBtn.addEventListener('click', () => {
    hasInteracted = true;
    triggerHaptic('medium');
    addStock(currentColor);

    if (lastActionWasRandom) {
      omakaseKeepCombo++;
      lastActionWasRandom = false; 
      if (omakaseKeepCombo >= 7) {
        omakaseKeepCombo = 0;
        triggerGameInvite('combo');
        return;
      }
    } else {
      omakaseKeepCombo = 0; 
    }

    keepTapCount++;
    if (keepTapCount >= 13) {
      keepTapCount = 0;
      resetTriggerCounters();
      triggerGameInvite('keep');
    }
  });

  const DISCOVERY_KEY = 'dress_game_discoveries';
  const TOTAL_SECRETS = 7; 
  const TRIGGER_COOLDOWN_MS = 15 * 60 * 1000; 
  const TRIGGER_COOLDOWN_KEY = 'dress_trigger_cooldowns';

    const ALT_HOME_UNLOCK_CODE = atob('OGJpdA==');
  const ALT_HOME_MODE_KEY = 'alt_home_mode';           
  const ALT_CODE_ANNOUNCED_KEY = 'alt_code_announced';

  function normalizeCode(str){
    return (str || '')
      .trim()
      .replace(/[ \u3000\-„Éº_]+/g, '')
      .replace(/[ÔºÅ-ÔΩû]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
      .toLowerCase();
  }

  function getDiscoveredCount(){
    try{
      const discovered = JSON.parse(localStorage.getItem(DISCOVERY_KEY) || '[]');
      return Array.isArray(discovered) ? new Set(discovered).size : 0;
    }catch(e){ return 0; }
  }
  function hasUnlockedAltHome(){
    return getDiscoveredCount() >= TOTAL_SECRETS;
  }

  function getAltMode(){
    try{ return sessionStorage.getItem(ALT_HOME_MODE_KEY) || ''; }catch(e){ return ''; }
  }
  function isAltMode(){
    return getAltMode() === '8bit';
  }

  function srgb255ToLinear(x){
    const c = x / 255;
    return (c <= 0.04045) ? (c / 12.92) : Math.pow((c + 0.055) / 1.055, 2.4);
  }
  function pickOnAccent(rgb){
    const R = srgb255ToLinear(rgb.r);
    const G = srgb255ToLinear(rgb.g);
    const B = srgb255ToLinear(rgb.b);
    const L = 0.2126 * R + 0.7152 * G + 0.0722 * B; 
    return (L > 0.55) ? '#06120c' : '#ffffff';
  }


  function update8bitTheme(hex){
    const rgb = hexToRgb(hex);
    if (!rgb) return;
    const on = pickOnAccent(rgb);
    document.body.style.setProperty('--gold-main', hex);
    document.body.style.setProperty('--on-accent', on);
    document.body.style.setProperty('--pixel-glow', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.16)`);
    document.body.style.setProperty('--pixel-glow2', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.10)`);

    const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
    if (hsl && typeof hsl.h === 'number') {
      const angle = (135 + hsl.h * 0.85) % 360;
      document.body.style.setProperty('--bg-angle', `${Math.round(angle)}deg`);
    }
  }

  function updateModeReturnLinks(){
    const show = document.body.classList.contains('alt-8bit');
    const disp = show ? 'block' : 'none';
    if (modeReturnLink) modeReturnLink.style.display = disp;
    if (modeReturnLinkRank) modeReturnLinkRank.style.display = disp;
  }

  window.addEventListener('resize', () => {
  });
  let bsodActive = false;
  let bsodCooldownUntil = 0;


  function hideBsod(){
    if (!bsodOverlay) return;
    bsodOverlay.classList.remove('show');
    bsodActive = false;
  }

  function showBsod(){
    if (!bsodOverlay || bsodActive) return;
    const now = Date.now();
    if (now < bsodCooldownUntil) return;

    bsodActive = true;
    bsodCooldownUntil = now + 6000;

    bsodOverlay.classList.add('show');
    triggerHaptic('heavy');

    setTimeout(() => {
      hideBsod();
      showToast('Ôºà„Éá„Éê„ÉÉ„Ç∞Ê≥®ÊÑè‚Ä¶ÂÜóË´á„Åß„ÅôÔºâ');
    }, 2600);
  }

  if (bsodOverlay) {
    bsodOverlay.addEventListener('click', hideBsod);
  }

  function applyAltMode(enabled){
    document.body.classList.toggle('alt-8bit', !!enabled);
    if (enabled) {
      update8bitTheme(currentColor);
      setupPixelDressCanvas();
      const rgb = hexToRgb(currentColor);
      if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        if (hsl) drawPixelDress(hsl.h, hsl.s, hsl.l);
      }
    } else {
      document.body.style.removeProperty('--gold-main');
      document.body.style.removeProperty('--on-accent');
      document.body.style.removeProperty('--pixel-glow');
      document.body.style.removeProperty('--pixel-glow2');
      document.body.style.removeProperty('--bg-angle');
      clearPixelDress();
    }
    updateModeReturnLinks();
  }

  function setAltMode(enabled){
    applyAltMode(enabled);
    try{
      if (enabled) sessionStorage.setItem(ALT_HOME_MODE_KEY, '8bit');
      else sessionStorage.removeItem(ALT_HOME_MODE_KEY);
    }catch(e){}
  }

  function checkTriggerCooldown(triggerId) {
    try {
      const data = JSON.parse(localStorage.getItem(TRIGGER_COOLDOWN_KEY) || '{}');
      const expiry = data[triggerId];
      if (expiry && Date.now() < expiry) return true;
    } catch(e) {}
    return false;
  }

  function setTriggerCooldown(triggerId) {
    try {
      const data = JSON.parse(localStorage.getItem(TRIGGER_COOLDOWN_KEY) || '{}');
      data[triggerId] = Date.now() + TRIGGER_COOLDOWN_MS;
      localStorage.setItem(TRIGGER_COOLDOWN_KEY, JSON.stringify(data));
    } catch(e) {}
  }

const _0xDec = function(s) {
  try {
    return decodeURIComponent(escape(atob(s)));
  } catch (e) { return s; }
};

const DISCOVERY_LABELS = {
  'default': '5L2V44KC5aSJ5pu044Gb44Ga44Gr5oqV56Wo44Oc44K/44Oz', 
  'title':   '44K/44Kk44OI44Or44KS6YCj57aa44K/44OD44OX',         
  'slider':  '44K544Op44Kk44OA44O844KS5YuV44GL44GX57aa44GR44KL',
  'random':  '44CM44GK44G+44GL44Gb44CN44KS6YCj57aa44K/44OD44OX',
  'keep':    '44CM44Kt44O844OX44CN44KS6YCj57aa44K/44OD44OX',     
  'combo':   '44CM44GK44G+44GL44Gb44CN4oaS44CM44Kt44O844OX44CN44KS57mw44KK6L+U44GZ',
  'dot':     '44Kt44O844OX44GX44Gf6Imy546J44KS6YCj57aa44K/44OD44OX' 
};

  function triggerGameInvite(discoveryId) {
    if (discoveryId) {
      let discovered = [];
      try {
        discovered = JSON.parse(localStorage.getItem(DISCOVERY_KEY) || '[]');
        if (!Array.isArray(discovered)) discovered = [];
      } catch(e) { discovered = []; }

      if (!discovered.includes(discoveryId)) {
        discovered.push(discoveryId);
        localStorage.setItem(DISCOVERY_KEY, JSON.stringify(discovered));
        updateDiscoveryUI();
      }
    }

    if (localStorage.getItem(PERMANENT_BAN_KEY)) return false;
    const banUntil = parseInt(localStorage.getItem(GAME_BAN_KEY) || '0', 10);
    if (!isNaN(banUntil) && Date.now() < banUntil) return false;
    if (discoveryId && discoveryId !== 'title' && checkTriggerCooldown(discoveryId)) return false;
    if (discoveryId && discoveryId !== 'title') setTriggerCooldown(discoveryId);
    
    setTimeout(() => { gameInviteModal.classList.add('open'); }, 500);
    return true;
  }

    function updateDiscoveryUI() {
    const el = document.getElementById('discoveryStatus');
    if (!el) return;

    let discovered = [];
    try {
      discovered = JSON.parse(localStorage.getItem(DISCOVERY_KEY) || '[]');
      if (!Array.isArray(discovered)) discovered = [];
    } catch(e) { discovered = []; }

    const unique = Array.from(new Set(discovered));
    const count = unique.length;
    const remain = Math.max(0, TOTAL_SECRETS - count);

    const parts = [];
    parts.push('<div class="discovery-wrap">');

    if (remain <= 0) {
      parts.push('<div class="discovery-complete">üéâ „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ üéâ</div>');
      parts.push('<div class="discovery-code-label">ÂÖ•Âäõ„Ç≥„Éº„Éâ</div>');
      parts.push(`<span class="unlock-code">${ALT_HOME_UNLOCK_CODE}</span>`);
      parts.push('<div class="discovery-code-note">‚ÄªÂêçÂâçÊ¨Ñ„Å´ÂÖ•Âäõ„Åô„Çã„Å®Âà•„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Çè„Çä„Åæ„Åô</div>');
    } else {
      parts.push(`<div class="discovery-remaining">Èö†„ÅóÊù°‰ª∂: ÊÆã„Çä ${remain} „Éë„Çø„Éº„É≥</div>`);
    }

    if (unique.length > 0) {
      parts.push('<div class="discovery-cleared">');
      parts.push('<div class="discovery-cleared-title">- CLEARED -</div>');
      unique.forEach(key => {
        const labelRaw = DISCOVERY_LABELS[key] ? _0xDec(DISCOVERY_LABELS[key]) : key;
        const label = sanitizeInput(labelRaw);
        parts.push(`<div class="discovery-cleared-item"><span class="check">‚úÖ</span><span class="label">${label}</span></div>`);
      });
      parts.push('</div>');
    }

    parts.push('</div>');
    el.innerHTML = parts.join('');
  }

gameDeclineBtn.addEventListener('click', () => {
    gameInviteModal.classList.remove('open');
    declineCount++;
    const isSuppressed = localStorage.getItem(SUPPRESS_CONFIRM_KEY);
    if (!isSuppressed && declineCount >= 2) {
      setTimeout(() => {
        const stopShowing = confirm("Ë£è„É¢„Éº„Éâ„ÅÆÈÄöÁü•„Çí„Ç™„Éï„Å´„Åó„Åæ„Åô„ÅãÔºü\nOK„Åß‰ª•ÂæåË°®Á§∫„Åó„Åæ„Åõ„Çì„ÄÇ");
        if (stopShowing) {
          localStorage.setItem(PERMANENT_BAN_KEY, 'true');
        } else {
          localStorage.setItem(SUPPRESS_CONFIRM_KEY, 'true');
          declineCount = 0;
        }
      }, 300);
    } else {
      resetTriggerCounters();
    }
  });

  gameAcceptBtn.addEventListener('click', () => {
    gameInviteModal.classList.remove('open');
    declineCount = 0;
    hasInteracted = true; 
    startGame();
  });

  let gameActive = false;
  let currentScore = 0;
  let timeLeft = 5.00;
  let gameInterval = null;
  let gameStartTime = 0;
  let currentGameToken = null;
  let tapLog = [];           
  let gameStartTimeLocal = 0; 

async function startGame() {
  tapGameBtn.disabled = true;
  gameScore.textContent = "0";
  currentScore = 0;
  
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'game_start');

    tapBtnText.textContent = "READY...";

    const res = await fetch(ENDPOINT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData
    });
    const data = await res.json();

    if (data.status === 'success') {
      currentGameToken = data.token; 
      startCountdown();
    } else {
      alert('„Ç≤„Éº„É†„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÈÄö‰ø°Áí∞Â¢É„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      resetGameUI();
    }
  } catch (e) {
    console.error(e);
    alert('ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
    resetGameUI();
  }
}

function resetGameUI() {
  tapGameBtn.disabled = true;
  tapBtnText.textContent = "ERROR";
}

function startCountdown() {
    gameScreen.classList.add('active');
    gameResultArea.style.display = "none";
    tapGameBtn.style.display = "flex";
    tapGameBtn.disabled = true;
    tapBtnText.textContent = "READY";
    gameScore.textContent = "0";
    gameTimer.textContent = "5.00";
    currentScore = 0;

    hasInteracted = true; 

    let count = 3;
    gameCountdown.textContent = count;
    gameCountdown.style.display = "grid";
    
    const countInterval = setInterval(() => {
      count--;
      if (count > 0) {
        gameCountdown.textContent = count;
      } else {
        clearInterval(countInterval);
        gameCountdown.textContent = "START!";
        setTimeout(() => {
          gameCountdown.style.display = "none";
          startMainGame();
        }, 1000);
      }
    }, 1000);
}

function startMainGame() {
    gameActive = true;
    timeLeft = 5.00;
    
    tapLog = [];
    gameStartTimeLocal = Date.now();
    
    tapGameBtn.disabled = false;
    tapBtnText.textContent = "TAP!";
    gameStartTime = Date.now();
    
    gameInterval = setInterval(() => {
      const now = Date.now();
      const elapsed = (now - gameStartTime) / 1000;
      const remain = 5.00 - elapsed;
      if (remain <= 0) {
        gameTimer.textContent = "0.00";
        finishGame();
      } else {
        gameTimer.textContent = remain.toFixed(2);
      }
    }, 33); 
  }

  async function finishGame() {
    clearInterval(gameInterval);
    gameActive = false;
    tapGameBtn.disabled = true;
    tapBtnText.textContent = "FINISH";
    setTimeout(() => {
      tapGameBtn.style.display = "none"; 
      gameNameInput.value = nameInput.value;
      gameResultArea.style.display = "flex";
    }, 1000);
  }

  function spawnParticles(x, y) {
    const particleCount = 8;
    const colors = ['#fff', '#E6A3AF', '#cda156', '#fffdf5'];
    for (let i = 0; i < particleCount; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      const size = Math.random() * 6 + 2;
      p.style.width = size + 'px';
      p.style.height = size + 'px';
      p.style.left = x + 'px';
      p.style.top = y + 'px';
      document.body.appendChild(p);
      const angle = Math.random() * Math.PI * 2;
      const velocity = Math.random() * 100 + 60;
      const tx = Math.cos(angle) * velocity;
      const ty = Math.sin(angle) * velocity;
      const anim = p.animate([
        { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
        { transform: `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(0)`, opacity: 0 }
      ], { duration: Math.random() * 400 + 400, easing: 'cubic-bezier(0.25, 1, 0.5, 1)' });
      anim.onfinish = () => p.remove();
    }
  }

  function createRipple(parent) {
    const ripple = document.createElement('div');
    ripple.style.position = 'absolute';
    ripple.style.borderRadius = '50%';
    ripple.style.border = '2px solid rgba(255,255,255,0.6)';
    ripple.style.width = '100%';
    ripple.style.height = '100%';
    ripple.style.top = '0';
    ripple.style.left = '0';
    ripple.style.pointerEvents = 'none';
    parent.appendChild(ripple);
    const anim = ripple.animate([
       { transform: 'scale(1)', opacity: 1, borderWidth: '2px' },
       { transform: 'scale(1.5)', opacity: 0, borderWidth: '0px' }
    ], { duration: 500, easing: 'ease-out' });
    anim.onfinish = () => ripple.remove();
  }

function handleTap(e) {
    tapGameBtn.style.transform = "scale(0.95)";
    setTimeout(()=> tapGameBtn.style.transform = "scale(1)", 50);

    if (gameActive) {
      const tapTime = Date.now() - gameStartTimeLocal;
      tapLog.push(tapTime);
      
      currentScore = tapLog.length;
      gameScore.textContent = currentScore;
      
      triggerHaptic('light');
      const rect = tapGameBtn.getBoundingClientRect();
      const x = e.clientX || (rect.left + rect.width / 2);
      const y = e.clientY || (rect.top + rect.height / 2);
      spawnParticles(x, y);
      createRipple(tapGameBtn);
    }
  }

  tapGameBtn.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    if (e.button !== 0) return;
    if (!tapGameBtn.disabled) {
       handleTap(e);
    }
  });

submitBtn.addEventListener('click', async () => {
    if (honeypot.value !== "") return;

    const rawVal = nameInput.value.trim();
    


    let name = sanitizeInput(rawVal);
    if (!name) { alert('„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); nameInput.focus(); return; }
    if (name.length > MAX_NAME_LENGTH) { alert(`„ÅäÂêçÂâç„ÅØ${MAX_NAME_LENGTH}ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`); nameInput.focus(); return; }
    
    name = name.replace(/[\u0000-\u001F\u007F]/g, '');

    if (!hasInteracted) {
       let discovered = [];
       try { discovered = JSON.parse(localStorage.getItem(DISCOVERY_KEY) || '[]'); } catch(e){}
       
       if (!discovered.includes('default') || localStorage.getItem(SUPPRESS_CONFIRM_KEY)) {
          const modalOpened = triggerGameInvite('default');
          if (modalOpened) return; 
       }
    }

    modalBody.innerHTML = '';
    
    const previewContainer = document.createElement('div');
    previewContainer.className = 'modal-preview-box';
    if (dressWrapper.dataset.mode === 'direct') {
      const svgDoc = dressObj.contentDocument;
      const originalSvg = svgDoc && svgDoc.querySelector('svg');
      if (originalSvg) {
        const cloneSvg = originalSvg.cloneNode(true);
        cloneSvg.removeAttribute('width'); cloneSvg.removeAttribute('height');
        cloneSvg.style.width = '100%'; cloneSvg.style.height = 'auto'; cloneSvg.style.display = 'block';
        cloneSvg.style.filter = 'drop-shadow(0 10px 10px rgba(0,0,0,0.15))';
        previewContainer.appendChild(cloneSvg);
      }
    } else {
      const imgClone = dressImg.cloneNode(true);
      imgClone.style.display = 'block'; imgClone.style.width = '100%'; imgClone.style.height = 'auto';
      imgClone.style.filter = dressImg.style.filter + ' drop-shadow(0 10px 10px rgba(0,0,0,0.15))';
      previewContainer.appendChild(imgClone);
    }
    modalBody.appendChild(previewContainer);

    const guestInfoDiv = document.createElement('div');
    guestInfoDiv.className = 'modal-guest-info';
    const labelSpan = document.createElement('span');
    labelSpan.className = 'modal-guest-label'; labelSpan.textContent = 'GUEST';
    const nameDiv = document.createElement('div');
    nameDiv.className = 'modal-guest-name'; nameDiv.textContent = name + ' Êßò';
    guestInfoDiv.appendChild(labelSpan); guestInfoDiv.appendChild(nameDiv);
    
    modalBody.appendChild(guestInfoDiv);

    const msgP = document.createElement('p');
    msgP.className = 'modal-msg'; msgP.textContent = '„Åì„ÅÆÂÜÖÂÆπ„ÅßÊäïÁ•®„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü';
    modalBody.appendChild(msgP);
    
    confirmModal.classList.add('open');
  });

  retryGameBtn.addEventListener('click', () => {
    gameResultArea.style.display = 'none';
    startGame();
  });

  if (gameSubmitBtn) {
    gameSubmitBtn.addEventListener('click', () => {
      const raw = (gameNameInput.value || '').trim();
      if (!raw) { alert('„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); gameNameInput.focus(); return; }
      if (raw.length > MAX_NAME_LENGTH) { alert(`„ÅäÂêçÂâç„ÅØ${MAX_NAME_LENGTH}ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`); gameNameInput.focus(); return; }

      if (/^[=+\-@]/.test(raw)) { alert('„Åù„ÅÆÂêçÂâç„ÅØ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì'); gameNameInput.focus(); return; }

      const name = raw.replace(/[\u0000-\u001F\u007F]/g, '');

      const infoEl = document.getElementById('colorRankingInfo');
      if (infoEl) {
        infoEl.style.display = 'none'; 
        infoEl.innerHTML = '';
      }

      rankingScreen.classList.add('active');
      rankingListContainer.innerHTML = '<div class="loading-spinner"></div>';
      updateDiscoveryUI();
      if (myScoreDisplay) myScoreDisplay.textContent = `„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢: ${currentScore}Âõû`;

      if (window.grecaptcha && gameRecaptchaWidgetId !== null) {
        pendingGameSubmit = { score: currentScore, name: name };

        recaptchaFallbackTimer = setTimeout(() => {
          if (!pendingGameSubmit) return;
          const { score, name: n } = pendingGameSubmit;
          pendingGameSubmit = null;
          submitAndShowRankingWithToken(score, n, '');
        }, 3500);

        try {
          grecaptcha.execute(gameRecaptchaWidgetId);
        } catch (e) {
          pendingGameSubmit = null;
          submitAndShowRankingWithToken(currentScore, name, '');
        }
      } else {
        submitAndShowRankingWithToken(currentScore, name, '');
      }
    });
  }

  if (skipRegisterBtn) {
    skipRegisterBtn.addEventListener('click', () => {
      gameNameInput.value = "";
      submitAndShowRankingWithToken(currentScore, "Guest", "", "get_ranking");
    });
  }
  
  if (rankRetryBtn) {
    rankRetryBtn.addEventListener('click', () => {
      rankingScreen.classList.remove('active');
      startGame();
    });
  }

async function submitAndShowRankingWithToken(score, name, recaptchaToken, actionType = 'game_score') {
  isColorRankingMode = false;  

  const infoEl = document.getElementById('colorRankingInfo');
  if (infoEl) { infoEl.style.display = 'none'; infoEl.innerHTML = ''; }
  const distEl = document.getElementById('colorDistanceInfo');
  if (distEl) { distEl.style.display = 'none'; distEl.innerHTML = ''; }
  const discoveryStatus = document.getElementById('discoveryStatus');
  if (discoveryStatus) { discoveryStatus.style.display = ''; }
  
  if (rankRetryBtn) rankRetryBtn.style.display = '';

  rankingScreen.classList.add('active');
  rankingListContainer.innerHTML = '<div class="loading-spinner"></div>';
  updateDiscoveryUI();

  if(myScoreDisplay) myScoreDisplay.textContent = `„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢: ${score}Âõû`;

const payload = {
    action: actionType,
    timestamp: new Date().toISOString(),
    name: name,
    clientId: CLIENT_ID,
    recaptchaToken: recaptchaToken || '',
    gameToken: currentGameToken || '',
    
    tapHistory: JSON.stringify(tapLog)
  };

  try {
    const body = new URLSearchParams(payload).toString();
    const response = await fetch(ENDPOINT_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: body
    });
    const result = await response.json();

    if (result.status === 'error') {
      alert(result.message || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„ÅüÔºà‰∏çÊ≠£„Å™„Çπ„Ç≥„Ç¢„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ');
      rankingScreen.classList.remove('active'); 
      return;
    }

    renderRanking(result.ranking, score, name);
  } catch(e) {
    rankingListContainer.innerHTML = '<p>„É©„É≥„Ç≠„É≥„Ç∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
  }
}


  let isColorRankingMode = false;
  let defaultRankingTitle = '';

  async function openColorRanking(secretWord){
    isColorRankingMode = true;

    const discoveryStatus = document.getElementById('discoveryStatus');
    if (discoveryStatus) {
      discoveryStatus.style.display = 'none';
    }

    const titleEl = rankingScreen && rankingScreen.querySelector('h3');
    if (titleEl) {
      if (!defaultRankingTitle) defaultRankingTitle = titleEl.textContent;
      titleEl.textContent = "DRESS COLOR RANKING";
    }

    if (rankRetryBtn) rankRetryBtn.style.display = 'none';

    rankingScreen.classList.add('active');
    rankingListContainer.innerHTML = '<div class="loading-spinner"></div>';
    
    if (myScoreDisplay) myScoreDisplay.textContent = '‰∏ä‰Ωç5ÂêçÔºà„Çø„ÉÉ„Éó„Åß„Éâ„É¨„ÇπË°®Á§∫Ôºâ';

    const infoEl = document.getElementById('colorRankingInfo');
    if (infoEl) {
      infoEl.style.display = 'none'; 
      infoEl.innerHTML = '';
    }

    const distEl = document.getElementById('colorDistanceInfo');
    if (distEl) {
      distEl.style.display = 'block';
      distEl.innerHTML =
        '<a href="https://ja.wikipedia.org/wiki/%E8%89%B2%E5%B7%AE" ' +
        '   target="_blank" rel="noopener noreferrer">' +
        'Ëâ≤„ÅÆËøë„Åï„ÅÆË®àÁÆóÊñπÊ≥ïÔºàCIEDE2000Ôºâ' +
        '</a>';
    }

    const payload = {
      timestamp: new Date().toISOString(),
      name: secretWord, 
      clientId: CLIENT_ID
    };

    try {
      const body = new URLSearchParams(payload).toString();
      const response = await fetch(ENDPOINT_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: body
      });
      const result = await response.json();

      if (result.secretColor && Array.isArray(result.secretColor)) {
        renderSecretColorDot(result.secretColor);
      }

      renderColorRanking(result.ranking);
    } catch (e) {
      rankingListContainer.innerHTML = '<p>„É©„É≥„Ç≠„É≥„Ç∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
    }
  }

  function renderSecretColorDot(rgbArray) {
    const infoEl = document.getElementById('colorRankingInfo');
    if (!infoEl) return;

    infoEl.style.display = 'block';
    infoEl.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.justifyContent = 'center';
    wrapper.style.gap = '8px';

    const label = document.createElement('span');
    label.textContent = 'Ê≠£Ëß£„ÅÆ„Éâ„É¨„ÇπÔºà‰∏∏„Çí„Çø„ÉÉ„ÉóÔºâ';

    const dot = document.createElement('button');
    dot.type = 'button';
    dot.style.width = '20px';
    dot.style.height = '20px';
    dot.style.borderRadius = '50%';
    dot.style.border = '1px solid rgba(0,0,0,0.15)';
    
    const colorStr = `rgb(${rgbArray.join(',')})`;
    dot.style.backgroundColor = colorStr;
    
    dot.style.cursor = 'pointer';
    dot.style.padding = '0';

    dot.addEventListener('click', () => {
      showDressPreviewModal('Ê≠£Ëß£„ÅÆ„Éâ„É¨„Çπ', rgbArray.join(','));
    });

    wrapper.appendChild(label);
    wrapper.appendChild(dot);
    infoEl.appendChild(wrapper);
  }


function renderColorRanking(list) {
  if (!list || !Array.isArray(list)) {
    rankingListContainer.innerHTML = '<p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    return;
  }

  rankingListContainer.innerHTML = '';
  const top10 = list.slice(0, 5);

  if (!top10.length) {
    rankingListContainer.innerHTML = '<p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    return;
  }

  let lastColor = null; 
  let lastRank  = 0;
  let pos       = 0;

  top10.forEach((item) => {
    pos++;

    let rank;
    if (lastColor !== null && item.color === lastColor) {
      rank = lastRank;
    } else {
      rank = pos;
      lastRank  = rank;
      lastColor = item.color;
    }

    const row = document.createElement('div');
    row.className = `ranking-item rank-${rank}`;
    row.style.cursor = 'pointer';

    const badge = document.createElement('div');
    badge.className = 'rank-badge';
    badge.textContent = rank;

    const nameDiv = document.createElement('div');
    nameDiv.className = 'rank-name';
    nameDiv.textContent = item.name;

    const viewDiv = document.createElement('div');
    viewDiv.className = 'rank-score';

    const colorBadge = document.createElement('div');
    colorBadge.style.width = '20px';
    colorBadge.style.height = '20px';
    colorBadge.style.borderRadius = '50%';
    colorBadge.style.border = '1px solid rgba(0,0,0,0.1)';
    colorBadge.style.display = 'inline-block';

    const c = item.color;
    if (typeof c === 'string' && c.indexOf(',') !== -1) {
      colorBadge.style.backgroundColor = `rgb(${c})`;
    } else {
      colorBadge.style.backgroundColor = c;
    }

    viewDiv.appendChild(colorBadge);

    row.appendChild(badge);
    row.appendChild(nameDiv);
    row.appendChild(viewDiv);

    row.addEventListener('click', () => {
      showDressPreviewModal(item.name, item.color);
    });

    rankingListContainer.appendChild(row);
  });
}


function renderRanking(list, myScore, myName) {
  if (!list || !Array.isArray(list)) {
    rankingListContainer.innerHTML = '<p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    return;
  }
  rankingListContainer.innerHTML = '';

  let lastScore = null; 
  let lastRank  = 0;    
  let pos       = 0;    

  list.forEach((item) => {
    pos++;

    let rank;
    if (lastScore !== null && item.score === lastScore) {
      rank = lastRank;
    } else {
      rank = pos;
      lastRank  = rank;
      lastScore = item.score;
    }

    const row = document.createElement('div');
    row.className = `ranking-item rank-${rank}`;

    const badge = document.createElement('div');
    badge.className = 'rank-badge';
    badge.textContent = rank;

    const nameDiv = document.createElement('div');
    nameDiv.className = 'rank-name';
    nameDiv.textContent = item.name;

    const scoreDiv = document.createElement('div');
    scoreDiv.className = 'rank-score';
    scoreDiv.textContent = item.score;

    row.appendChild(badge);
    row.appendChild(nameDiv);
    row.appendChild(scoreDiv);
    rankingListContainer.appendChild(row);
  });
}


  backToMainBtn.addEventListener('click', () => {
    rankingScreen.classList.remove('active');
    gameScreen.classList.remove('active');
    hasInteracted = true;
    resetTriggerCounters(); 

    if (isColorRankingMode) {
      isColorRankingMode = false;
      closeColorPreview();
      if (rankRetryBtn) rankRetryBtn.style.display = '';
      const titleEl = rankingScreen && rankingScreen.querySelector('h3');
      if (titleEl && defaultRankingTitle) titleEl.textContent = defaultRankingTitle;
      if (myScoreDisplay) myScoreDisplay.textContent = '';
    }
  });

  function resetTriggerCounters() {
    omakaseKeepCombo = 0;
    keepTapCount = 0;
    dotTapCount = 0;
    sliderShakeCount = 0;
    titleTapCount = 0;
    dressTapCount = 0;
    omakaseTapCount = 0;
    lastActionWasRandom = false;
  }

  let dotTapCount = 0;
  let dotTapTimer = null;

  function addStock(hex) {
    const placeholder = stockArea.querySelector('.stock-placeholder');
    if (placeholder) placeholder.remove();

    while (stockArea.childElementCount >= 5) {
      stockArea.removeChild(stockArea.firstElementChild);
    }
    
    const newDot = document.createElement('div');
    newDot.className = 'stock-dot';
    newDot.style.background = hex;
    newDot.style.opacity = '0'; 

    newDot.addEventListener('click', () => {
      hasInteracted = true;
      triggerHaptic('light'); 
      initColor(hex);
      newDot.style.transform = 'scale(1.2)';
      setTimeout(()=> newDot.style.transform = '', 200);

      if (dotTapTimer) clearTimeout(dotTapTimer);
      dotTapTimer = setTimeout(() => { dotTapCount = 0; }, 10000);
      dotTapCount++;
      if (dotTapCount >= 7) {
        dotTapCount = 0;
        resetTriggerCounters();
        triggerGameInvite('dot');
      }
    });

    stockArea.appendChild(newDot);
    runFlyAnimation(colorChip, newDot, hex);
  }

  function runFlyAnimation(startElem, endElem, color) {
    const startRect = startElem.getBoundingClientRect();
    const endRect = endElem.getBoundingClientRect();
    const flyer = document.createElement('div');
    flyer.style.position = 'fixed';
    flyer.style.width = '32px';
    flyer.style.height = '32px';
    flyer.style.borderRadius = '50%';
    flyer.style.backgroundColor = color;
    flyer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    flyer.style.zIndex = '9999';
    flyer.style.pointerEvents = 'none';
    flyer.style.left = startRect.left + 'px';
    flyer.style.top = startRect.top + 'px';
    document.body.appendChild(flyer);

    const anim = flyer.animate([
      { left: startRect.left + 'px', top: startRect.top + 'px', transform: 'scale(1)' },
      { left: endRect.left + 'px', top: endRect.top + 'px', transform: 'scale(0.8)' }
    ], { duration: 500, easing: 'cubic-bezier(0.2, 0.8, 0.2, 1)' });

    anim.onfinish = () => {
      flyer.remove();
      endElem.style.opacity = '1';
      endElem.classList.add('pop-anim');
      setTimeout(() => endElem.classList.remove('pop-anim'), 500);
    };
  }

  function handleDressLoaded() {
    if (dressObj.dataset.loaded === 'true') return;
    dressObj.dataset.loaded = 'true';

    const ok = tryWireSvgDirect();
    if (!ok) enableFallback();
    
    initColor(currentColor);
    
    requestAnimationFrame(() => {
      dressObj.style.opacity = '1';
    });
  }

  dressObj.addEventListener('load', handleDressLoaded);

  if (dressObj.contentDocument && 
      dressObj.contentDocument.readyState === 'complete' &&
      dressObj.contentDocument.documentElement) {
    handleDressLoaded();
  }

  setTimeout(() => {
    if (getComputedStyle(dressObj).opacity === '0') {
      handleDressLoaded();
    }
  }, 1000);
  function checkRateLimit(){
    const now = Date.now();
    let arr;
    try { arr = JSON.parse(localStorage.getItem(RATE_LIMIT_KEY) || '[]'); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
    arr = arr.map(t => typeof t === 'number' ? t : 0).filter(t => t > 0 && now - t < RATE_LIMIT_WINDOW_MS);
    let waitMs = 0;
    if (arr.length >= RATE_LIMIT_MAX) {
      const oldest = arr[0];
      const w = RATE_LIMIT_WINDOW_MS - (now - oldest);
      if (w > waitMs) waitMs = w;
    }
    if (arr.length) {
      const last = arr[arr.length - 1];
      const w = RATE_LIMIT_MIN_INTERVAL_MS - (now - last);
      if (w > waitMs) waitMs = w;
    }
    return { canSubmit: waitMs <= 0, waitMs, history: arr };
  }

  function registerSubmit(history){
    const now = Date.now();
    const arr = (history || []).concat(now);
    try { localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(arr)); } catch(e){}
  }

  function formatWaitMessage(ms){
    const sec = Math.ceil(ms / 1000);
    if (sec < 60) return `${sec}ÁßíÂæå„Å´ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ`;
    const min = Math.ceil(sec / 60);
    return `${min}ÂàÜÂæå„Å´ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ`;
  }

  const PENDING_KEY = 'dress_pending_submissions';
  const ENDPOINT_URL = atob('aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J5bFpHWUVxcHQyeXE1MUpyTFp0N2ZXcDF3S2RkRVhvNkZQU2hVU3c3SkpIaFR1X2taTmpQSWJoRVlWdWc1bmxyRk9TZy9leGVj');
  function enqueueSubmission(payload){
    let arr;
    try { arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
    arr.push(payload);
    try { localStorage.setItem(PENDING_KEY, JSON.stringify(arr)); } catch(e){}
  }

  async function flushQueue(endpoint){
    let arr;
    try { arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
    if (!arr.length) return;
    const remain = [];
    for (const p of arr) {
      const ok = await sendPayload(endpoint, p, true);
      if (!ok) remain.push(p);
    }
    try { localStorage.setItem(PENDING_KEY, JSON.stringify(remain)); } catch(e){}
  }

  function showToast(msg='ÊäïÁ•®„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü'){
    toast.textContent = msg;

    if (!document.body.classList.contains('alt-8bit')) {
      const ae = document.activeElement;
      const keyboardLikely = ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA');
      if (keyboardLikely) {
        toast.style.bottom = 'auto';
        toast.style.top = '18px';
      } else {
        toast.style.top = '';
        toast.style.bottom = '';
      }
    } else {
      toast.style.top = '';
      toast.style.bottom = '';
    }

    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
  }

  async function sendPayload(endpoint, payload, isRetry=false){
    try {
      const body = new URLSearchParams(payload).toString();
      if (navigator.sendBeacon && !payload.action) {
        const ok = navigator.sendBeacon(endpoint, new Blob([body], { type: 'application/x-www-form-urlencoded;charset=UTF-8' }));
        if (ok) return true;
      }
      await fetch(endpoint, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body,
        mode:'no-cors'
      });
      return true;
    } catch (e) {
      if (!isRetry && !payload.action) enqueueSubmission(payload);
      return false;
    }
  }

  if (nameInput) {
    nameInput.addEventListener('input', () => {
      const raw = nameInput.value || '';
      if (!looksLikeDebugAttempt(raw)) return;

      nameInput.value = '';
      nameInput.blur();
      showBsod();
    });
  }


  if (nameInput) {
    nameInput.addEventListener('input', () => {

      const v = normalizeCode(nameInput.value);
      if (v !== ALT_HOME_UNLOCK_CODE) return;

      const enable = !document.body.classList.contains('alt-8bit');
      setAltMode(enable);

      nameInput.value = '';

      const label = (enable) ? '8BIT' : 'NORMAL';
      showToast(`MODE: ${label}`);
    });
  }

  cancelSendBtn.addEventListener('click', () => { confirmModal.classList.remove('open'); });

finalSendBtn.addEventListener('click', async () => {
    confirmModal.classList.remove('open');
    const name = sanitizeInput(nameInput.value.trim().replace(/[\u0000-\u001F\u007F]/g, ''));
    
    const rl = checkRateLimit();
    if (!rl.canSubmit) { showToast(formatWaitMessage(rl.waitMs)); return; }
    registerSubmit(rl.history);

    const rgb = hexToRgb(currentColor);
    const colorToSend = rgb ? `${rgb.r}, ${rgb.g}, ${rgb.b}` : currentColor;
    
    const payload = {
      timestamp: new Date().toISOString(),
      name: name,
      color: colorToSend,
      userAgent: navigator.userAgent,
      clientId: CLIENT_ID
    };

    try {
      const body = new URLSearchParams(payload).toString();
      const response = await fetch(ENDPOINT_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: body
      });
      const result = await response.json();

      if (result.status === 'success') {
        if (result.ranking && result.secretColor) {
           showToast('ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ: Ëâ≤ÂΩì„Å¶„É©„É≥„Ç≠„É≥„Ç∞„ÇíË°®Á§∫„Åó„Åæ„Åô');
           renderSecretColorDot(result.secretColor);
           renderColorRanking(result.ranking);
           rankingScreen.classList.add('active'); 
           
           isColorRankingMode = true;
           const titleEl = rankingScreen.querySelector('h3');
           if (titleEl) {
             if (!defaultRankingTitle) defaultRankingTitle = titleEl.textContent;
             titleEl.textContent = "DRESS COLOR RANKING";
           }
           if (myScoreDisplay) myScoreDisplay.textContent = '‰∏ä‰Ωç5ÂêçÔºà„Çø„ÉÉ„Éó„Åß„Éâ„É¨„ÇπË°®Á§∫Ôºâ';

        } else {
           showToast('ÊäïÁ•®„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
        }
      } else {
        enqueueSubmission(payload);
        showToast('ÊäïÁ•®„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü(„Ç™„Éï„É©„Ç§„É≥‰øùÂ≠ò)');
      }
    } catch (e) {
      enqueueSubmission(payload);
      showToast('ÊäïÁ•®„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü(ÈÄö‰ø°„Ç®„É©„Éº‰øùÂ≠ò)');
    }
  });

  function triggerHaptic(style = 'light') {
    if (!navigator.vibrate) return;
    try {
      switch (style) {
        case 'light': navigator.vibrate(5); break;
        case 'medium': navigator.vibrate(15); break;
        case 'heavy': navigator.vibrate([30, 50, 30]); break;
      }
    } catch(e){}
  }
  
  let sliderStartTime = 0;  
  let sliderGapTimer = null; 
  let sliderShakeCount = 0;

  [hueRange, satRange, lightRange].forEach(range => {
    let lastVal = parseInt(range.value, 10);
    range.addEventListener('input', (e) => {
      const currentVal = parseInt(e.target.value, 10);
      
      if (Math.abs(currentVal - lastVal) >= 3) {
          triggerHaptic('light');
      }

      lastVal = currentVal;
      
      if (sliderStartTime === 0) {
        sliderStartTime = Date.now();
      }
      if (sliderGapTimer) clearTimeout(sliderGapTimer);
      sliderGapTimer = setTimeout(() => {
        sliderStartTime = 0;
      }, 400); 

      if (Date.now() - sliderStartTime >= 3500) {
        sliderStartTime = 0; 
        resetTriggerCounters();
        triggerGameInvite('slider');
      }
    }, {passive: true});
  });

  const clickableIds = ['submitBtn', 'randomBtn', 'keepBtn', 'cancelSendBtn', 'finalSendBtn'];
  clickableIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.addEventListener('click', () => { triggerHaptic('medium'); }); }
  });
  if (colorInput) { colorInput.addEventListener('click', () => triggerHaptic('medium')); }

  window.addEventListener('online', () => flushQueue(ENDPOINT_URL));
  if (document.readyState === 'complete') {
    initColor(currentColor);
    if (isAltMode()) applyAltMode(true);
  } else {
    window.addEventListener('load', () => {
      initColor(currentColor);
      if (isAltMode()) applyAltMode(true);
    });
  }

  const titleElement = document.querySelector('.card-header h2'); 
  let titleTapCount = 0;
  let titleTapTimer = null;

  if (titleElement) {
    titleElement.style.cursor = 'pointer'; 
    titleElement.style.userSelect = 'none';

    titleElement.addEventListener('click', () => {
      triggerHaptic('light');
      titleElement.animate([
        { transform: 'scale(1)' },
        { transform: 'scale(0.9) translateY(2px)', opacity: 0.7 },
        { transform: 'scale(1)' }
      ], { duration: 100 });
      titleTapCount++;
      if (titleTapTimer) clearTimeout(titleTapTimer);
      titleTapTimer = setTimeout(() => { titleTapCount = 0; }, 5000); 
      if (titleTapCount >= 5) {
        titleTapCount = 0;
        resetTriggerCounters();
        triggerGameInvite('title');
      }
    });
  }
</script>
<script src="https://www.google.com/recaptcha/api.js?onload=onGameRecaptchaLoad&render=explicit" async defer></script>
</body>
</html>